---
title: "FigureYa203ComBat"
author: "小丫画图出品"
date: "2020-10-30"
output: html_document
---
欢迎关注“小丫画图”公众号，回复“小白”，看小视频，实现点鼠标跑代码。

小丫微信: epigenomics  E-mail: figureya@126.com

作者：大鱼海棠

单位：中国药科大学国家天然药物重点实验室，生物统计与计算药学研究中心

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

想众筹这篇文章里的数据处理方法，TCGA的RNA-seq数据和不同平台的microarray数据合并及标准化，希望能够得到相对统一的处理方式。

![](example.png)

跟FigureYa201ClusterCorrelation出自同一篇文章，出自<https://www.cell.com/molecular-therapy-family/nucleic-acids/fulltext/S2162-2531(20)30259-6>

# 应用场景

不同平台的表达谱去除批次效应，绘制PCA图查看效果。

这里采用的是R包sva中的combat。

另外，还有一些文章采用非经典的去除批次效应的方式，例如FigureYa117multilinearDE。

# 环境设置

使用国内镜像安装包

```{r}
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.tuna.tsinghua.edu.cn/bioconductor/")

```

加载包

```{r}
library(TCGAbiolinks)
library(sva)
library(cluster)
library(oompaBase)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

自定义函数

```{r}
# 加载自定义函数，用于绘制PCA图
source("batchPCA.R")

# 肿瘤样本的FPKM转TPM (参考FigureYa22FPKM2TPM)
fpkmToTpm <- function(fpkm)
{
  exp(log(fpkm) - log(sum(fpkm)) + log(1e6))
}
```

# 输入文件获得

这里以一种TCGA肿瘤和两套GEO芯片数据为例，处理更多数据集的方式也是一样的。

如果你的表达矩阵已处理成easy_input_TCGA.csv和easy_input_GSE\*.csv的格式，就可以跳过这步，直接进入“检查数据的量级”。

三个待合并的数据集（表达矩阵）较大，已上传微云<https://share.weiyun.com/9HCHPNBi>

## TCGA数据下载及预处理

```{r eval=FALSE}
# 下载TCGA-HNSC的FPKM数据
expquery <- GDCquery(project = "TCGA-HNSC", 
                     data.category = "Transcriptome Profiling",
                     data.type = "Gene Expression Quantification",
                     workflow.type = "HTSeq - FPKM"
)
GDCdownload(expquery,directory = "GDCdata")
expquery2 <- GDCprepare(expquery,directory = "GDCdata",summarizedExperiment = T)
expMatrix <- TCGAanalyze_Preprocessing(expquery2)
colnames(expMatrix) <- substr(colnames(expMatrix), start = 1,stop = 15)
normsamples <- colnames(expMatrix)[which(substr(colnames(expMatrix),14,15) == "11")] # 取正常样本，后面没用到
tumorsamples <- colnames(expMatrix)[which(substr(colnames(expMatrix),14,15) == "01")] # 取肿瘤样本

# 把肿瘤样本的FPKM转成TPM
tpms <- as.data.frame(round(apply(expMatrix[,tumorsamples],2,fpkmToTpm), 2))
dim(tpms)
tpms[1:3,1:3]

# 去除低表达样本，有利于在信号强度上更接近芯片 (取行mad > 0.5的基因)
tpms <- tpms[apply(tpms, 1, mad) > 0.5,]
dim(tpms)

# 加载基因注释文件 (参考FigureYa34Count2FPKMv2)
Ginfo <- read.table("overlapTable27.txt",sep = "\t",row.names = 1,check.names = F, stringsAsFactors = F,header = T)

# 匹配Gene symbol并重名取均值
comgene <- intersect(rownames(tpms),rownames(Ginfo))
tpms <- tpms[comgene,]
Ginfo <- Ginfo[comgene,]
tpms$Gene <- as.character(Ginfo$genename)
tpms.hugo <- apply(tpms[,setdiff(colnames(tpms), "Gene")], 2, function(x) tapply(x, INDEX=factor(tpms$Gene), FUN=mean, na.rm=TRUE))
tpms.hugo <- as.data.frame(round(tpms.hugo,2))
tpms.hugo[1:3, 1:3]

# 保存到文件
write.csv(tpms.hugo, "easy_input_TCGA.csv", quote = F)
```

## GEO芯片数据下载及预处理

这里用sangerbox下载GEO表达谱数据及预处理，方法见`GEO_sangerbox.docx`文件。生成`gse41613.expr.txt`以及`gse65858.expr.txt`后进行如下处理。

（还可以用`FigureYa59Plus_GEO2DEG`<https://www.yuque.com/figureya/figureyaplus/figureya59p>下载GEO芯片数据并预处理，获得表达矩阵easy_input_expr.csv文件）

```{r eval=FALSE}
# GSE41613
gse41613.expr <- read.delim("gse41613.expr.txt",sep = "\t",row.names = 1,check.names = F,stringsAsFactors = F,header = T)
gse41613.expr[1:3,1:3] # 注意到行名里存在多种匹配，取///符号前的基因名（可以在EXCEL里检查一下，但不要用EXCEL进行任何操作，千万不要保存）
gse41613.expr$Gene <- sapply(strsplit(rownames(gse41613.expr)," /// ",fixed = T),"[",1)
gse41613.expr <- apply(gse41613.expr[,setdiff(colnames(gse41613.expr), "Gene")], 2, function(x) tapply(x, INDEX=factor(gse41613.expr$Gene), FUN=mean, na.rm=TRUE))
gse41613.expr <- as.data.frame(round(gse41613.expr,2))
write.csv(gse41613.expr, "easy_input_GSE41613.csv", quote = F)

# GSE65858
gse65858.expr <- read.delim("gse65858.expr.txt",sep = "\t",row.names = 1,check.names = F,stringsAsFactors = F,header = T)
gse65858.expr[1:3,1:3] # 检查一下，行名很干净，不用处理
gse65858.expr <- as.data.frame(round(gse65858.expr,2))
write.csv(gse65858.expr, "easy_input_GSE65858.csv", quote = F)
```

# 检查两类数据的量级

通过取对数，让两类数据的数量级达到同一范围。

```{r}
# TCGA
tpms.hugo <- read.csv("easy_input_TCGA.csv", row.names = 1)
tpms.hugo[1:3, 1:3]
range(tpms.hugo) 
# 量级很大，所以取对数
tcga.expr <- log2(tpms.hugo + 1)
range(tcga.expr) # 取完对数后，量级在0-20

# GEO microarray
gse41613.expr <- read.csv("easy_input_GSE41613.csv", row.names = 1)
gse65858.expr <- read.csv("easy_input_GSE65858.csv", row.names = 1)
range(gse41613.expr) # 量级在0-20
range(gse65858.expr) # 量级在0-20
```

# 合并数据集、检查批次效应

```{r}
# 设置颜色
blue <- "#2874C5"
yellow <- "#EABF00"
green <- "#008B8A"

# 提取在三套数据中都出现的基因
comgene <- intersect(intersect(rownames(tcga.expr), rownames(gse41613.expr)), rownames(gse65858.expr))
# 合并三套数据
combined.expr <- cbind.data.frame(tcga.expr[comgene,],
                                  gse41613.expr[comgene,],
                                  gse65858.expr[comgene,])

# 绘制PCA散点图，检查批次效应
batchPCA(indata = t(scale(t(combined.expr))),
         batch = rep(c("TCGA","GSE41613","GSE65858"), times = c(ncol(tcga.expr),ncol(gse41613.expr),ncol(gse65858.expr))),
         fig.dir = ".",
         PCA.fig.title = "Raw PCA for combined expression profile",
         cols = c(blue, yellow, green),
         showID = F,
         cex = 0.7,
         showLegend = T) # 可以看到三个数据集(批次)完全分开，说明有很严重的批次效应
range(combined.expr)
```

![](Raw PCA for combined expression profile.pdf)

# combat去除批次效应，再次检查

```{r}
# 去除批次效应
batch <- data.frame(batch = rep(c("TCGA","GSE41613","GSE65858"), times = c(ncol(tcga.expr),ncol(gse41613.expr),ncol(gse65858.expr))))
modcombat = model.matrix(~1, data = batch)
combined.expr.combat <- as.data.frame(ComBat(dat=as.matrix(combined.expr), batch=batch$batch, mod=modcombat))

# 输出到文件
# 这里保存前三个基因，便于传输和查看
write.csv(combined.expr.combat[1:3,], "output_combined_expr.csv", quote = F)
# 实际使用时请运行下面这行，获得全部基因在三个数据集中的表达矩阵
#write.csv(combined.expr.combat, "output_combined_expr.csv", quote = F)

# 绘制PCA散点图，检查批次效应
batchPCA(indata = t(scale(t(combined.expr.combat))),
         batch = rep(c("TCGA","GSE41613","GSE65858"), times = c(ncol(tcga.expr),ncol(gse41613.expr),ncol(gse65858.expr))),
         fig.dir = ".",
         PCA.fig.title = "Combat PCA for combined expression profile",
         cols = c(blue, yellow, green),
         showID = F,
         cex = 0.7,
         showLegend = T) # 可以看到三个数据集(批次)混杂在了一次，说明批次效应被基本消除
range(combined.expr.combat)
```

![](Combat PCA for combined expression profile.pdf)

# Session Info

```{r}
sessionInfo()
```