---
title: "FigureYa99smoothHRv2"
author: "小丫画图出品"
date: "2019-5-31"
output: html_document
---
欢迎关注“小丫画图”公众号，同名知识星球等你加入

小丫微信: epigenomics  E-mail: figureya@126.com

作者：大鱼海棠

单位：Research Center of Biostatistics and Computational Pharmacy, China Pharmaceutical University

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

限制性三次样条插值法（RCS）解决连续性变量对风险的非线性影响。

![](example.png)

出自<https://academic.oup.com/eurheartj/article/39/14/1181/4710060>

## 应用场景

1. 连续变量对风险的影响可能是非线性的，忽略这种非线性影响会对结果造成干扰；
2. 量化连续变量对各个取值处，以基线（参考点）为参考时候的风险比。

具体理论推导和细节请见文档中“理论参考”文件夹

## 环境设置

使用国内镜像安装包

```r
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
install.packages("smoothHR")
```

加载包

```{r}
library(smoothHR)
library(survival)
#library(rms) # 用于产生限制性三次样条
library(Hmisc) # 用于产生限制性三次样条（推荐，参数更精确）

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

## 输入文件

easy_input.csv，因为是生存分析的风险计算，所以生存状态（fstat），生存时间（lenfol），以及至少一个协变量（连续变量bmi）是必须的，此处还加了个协变量（二分类变量gender）。

数据来源：smmothHR包自带数据whas500，选了4个变量保存到easy_input.csv文件，便于小伙伴模仿格式。该测试结果仅展示如何对连续变量进行RCS下的Cox回归，无任何临床意义。

具体到实际问题，如果要控制其他因素对风险的影响，就要纳入更多的变量，这个没有固定的。这个众筹只是实现如何利用三次样条量化连续变量对HR的影响，具体要多少变量，具体问题具体分析，毕竟这是一个统计问题，没有通解。

```{r}
whas500 <- read.csv("easy_input.csv")
head(whas500)
```

## 开始计算

### 寻找样条knot数

对于RCS而言，knots一般在3-5，太多会造成过拟合。

具体选择参考文献补充材料（supplementary_appendix，根据AIC准则筛选AIC最小的knots，一般为3）：

The number of knots was chosen as the number that gave the best fit as assessed by the lowest value of the Akaike information criterion. 

If results were similar (within 2 units of the best fit), the model with fewest knots were chosen to avoid overfitting. 

```{r}
for (i in 3:5) {
  fit <- coxph(Surv(lenfol, fstat)~rcspline.eval(whas500$bmi,nk=i,inclx = T)+gender,data=whas500, x=TRUE)
  tmp <- extractAIC(fit)
  if(i == 3) {AIC = tmp[2]; nk = 3}
  if(tmp[2] < AIC) {AIC = tmp[2]; nk = i} #nk保存最优的knots数目，且样条数目为nk-2。具体见参考文献“理论1.pdf”第2页2.3节公式1
}
```

### 拟合Cox比例风险回归模型 ###

这里Cox回归模型考虑两个变量：bmi以及gender，其中bmi为连续变量，而gender为分类变量

连续变量对风险的影响有时可能是非线性的，因此使用RCS样条化做非线性处理。

```{r}
# 连续变量bmi被样条化
fit <- coxph(Surv(lenfol, fstat)~rcspline.eval(whas500$bmi,nk=nk,inclx = T)+gender,data=whas500, x=TRUE) # 这里Hmisc包中的rcspline.eval有多个参数，inclx=T表示包含被样条的数据本身，具体请参考?rcspline.eval
hr1 <- smoothHR(data=whas500, coxfit=fit) #光滑HR
print(hr1) #注意到此时模型p值，协变量bmi以及样条p值均显著，说明该连续变量对生存的风险可能是非线性的

p <- summary(hr1$coxfit) #注意如果有超过3个knots，也就是多于2个样条，个人觉得p-non-linear就不止一个了

# 设置参考值
refvalue <- (18.5+25)/2 #这是一个具有生物/医学意义的参考值，见参考文献“理论2.pdf”第18页标黄。无论参考值为何，该点处的HR为1，即Zi=Ziref，具体见第6页公式2.6

# 将参考值转换为prob参数(predict函数中直接使用pred.value似乎存在bug)
prob <- max(which(quantile(whas500$bmi, seq(0, 1, len = 1000)) <= refvalue))/1000

# 取出光滑的HR散点
smoothlogHR.point <- as.data.frame(predict(hr1, 
                          predictor="bmi", # 这是预测变量
                          prob = prob, 
 #这里替代为参考值转换的prob，当然也可以直接根据分位数设置参考值，比如bmi的中位数，也可以设置上四分位等等，总之是有生物学意义的
                          prediction.values = seq(min(whas500$bmi), max(whas500$bmi), length.out = 1000), conf.level=0.95)) #预测精度，输出1000个散点用于自定义图形绘制
```

## 开始画图

绘制RCS曲线

```{r}
# 设置密度曲线的背景色
violet <- "#89439B"

# 绘制左右双坐标轴baseplot
pdf("smooth HR with RCS.pdf",width = 5,height = 5)
par(mar = c(5, 4, 4, 4) + 0.3)
par(xpd=NA)

ylim.bot <- min(exp(smoothlogHR.point$LnHR),exp(smoothlogHR.point$`lower .95`),exp(smoothlogHR.point$`upper .95`))
ylim.top <- max(exp(smoothlogHR.point$LnHR),exp(smoothlogHR.point$`lower .95`),exp(smoothlogHR.point$`upper .95`))

# 先画密度图以免遮挡下面的线图
dens <- density(whas500$bmi) # 计算密度
plot(dens$x,dens$y, col=ggplot2::alpha(violet,0.5), type="l", xlab = "", ylab = "",xaxt="n",yaxt="n")
polygon(dens$x,dens$y,col = ggplot2::alpha(violet,0.5),border = ggplot2::alpha(violet,0.5)) # 颜色透明化防遮盖线条
axis(side=4, at = pretty(range(dens$y))[-length(pretty(range(dens$y)))])
mtext("Fraction of population (Density)", side=4, line=2)

par(new=TRUE) # 新增画布
plot(smoothlogHR.point[,1],exp(smoothlogHR.point$LnHR), # 由于文献里用的是HR，所以将logHR求指数转为HR
     xlab = "BMI",ylab = paste0("HR where the refvalue for BMI is ",refvalue),
     type = "l",ylim = c(ylim.bot,ylim.top),
     col="red",lwd=2) # 可以看出以refvalue为参考点，随着BMI升高，风险下降较快，但当BMI越大于30时风险趋近稳定
lines(smoothlogHR.point[,1],exp(smoothlogHR.point$`lower .95`),lty=2,lwd=1.5)
lines(smoothlogHR.point[,1],exp(smoothlogHR.point$`upper .95`),lty=2,lwd=1.5)
lines(x=range(smoothlogHR.point[,1]),y=c(1,1),lty=3,col="grey40",lwd=1.3) # 由于是HR，所以阈值为1，如果想用logHR，阈值则为0
points(refvalue,1,pch=16,cex=1.2)
text(refvalue + 5, 1.5, paste0("refvalue = ",refvalue)) # 附上refvalue的值，具体位置可以自己修改

# 绘制图例，注意非线性p值在变量p中的位置
legend("topright",
       paste0("P-overall ",ifelse(round(p$logtest[3],3) < 0.001,"< 0.001",round(p$logtest[3],3)),
              "\nP-non-linear = ",ifelse(round(p$coefficients[2,5],3) < 0.001,"< 0.001",round(p$coefficients[2,5],3))),
       bty="n",cex=0.8)

legend("bottomleft",lty = c(1,2),col = c("red","black"),
       c("Estimation","95% CI"),
       bty="n",cex=0.8)

invisible(dev.off())
```

![](smooth HR with RCS.pdf)

```{r}
sessionInfo()
```