---
title: "FigureYa13GSEA_JavaV2_update"
author: "小丫画图出品"
date: "2019-8-10"
output: html_document
---
欢迎关注“小丫画图”公众号，同名知识星球等你加入

小丫微信: epigenomics  E-mail: figureya@126.com

作者：小丫

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

已经用[Java版GSEA](http://software.broadinstitute.org/gsea/index.jsp)做出了GSEA分析结果，想自己画图。

在小丫画图公众号回复“GSEA”查看GSEA结果在更多文章中的展示方式。

图一：点图 + 条码

![](example1.png)

出自<https://science.sciencemag.org/content/354/6316/1160>

图二：线图 + 条码

![](example2.png)

出自<http://jem.rupress.org/content/214/8/2369.long>

图三：条码 + 热图

![](example3.png)

出自<https://thorax.bmj.com/content/69/1/14>

## 应用场景

以Java版GSEA的输出结果作为输入，DIY结果图，把多个通路画到一张图里。

如果你用clusterProfiler做的GSEA分析，想要DIY结果图，把多个通路画到一张图，或者把同一通路的多组对比画在一张图上，请用FigureYa60GSEA_clusterprofiler。

## 环境设置

使用国内镜像安装包

```{r}
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
```

加载包

```{r}
library(plyr)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
library(grid)
library(cowplot)
```

## 输入数据的准备

Java版GSEA的输出文件夹中有每个通路的Excel文件，把你感兴趣的通路的Excel文件复制到当前文件夹。

读取xls文件，合并

```{r, message=FALSE, warning=FALSE}
fnames <- Sys.glob("*.xls")
fdataset <- lapply(fnames,read.delim)
names(fdataset) <- fnames
result <- ldply(fdataset, data.frame)
result$pathway <- unlist(strsplit(result$.id,split = ".xls"))
head(result)

# pathway的颜色，自定义足够多的颜色
mycol <- c("red","navy","darkgreen","blueviolet","chocolate4")
```

## 开始画图

用官方GSEA输出的Excel文件重新画图，画这种散点图最合适。如果画折线图，你会发现跟Java版GSEA输出的图像不一致。那是因为官方GSEA输出的Excel文件不是所有基因的enrichment score，它只给出了这个通路内的基因的enrichment score。

### 图一：点图（enrichment score） + 条码（rank）

先画点图

```{r,fig.height=4,fig.width=8}
ppoint <- ggplot(result, aes(x=RANK.IN.GENE.LIST,
                             y=RUNNING.ES,fill=pathway,group=pathway))+
  #用带黑圈的点，优点是在点密集的位置也能看出有多个点
  geom_point(shape=21) + 
  scale_fill_manual(values = mycol) + #用自定义的颜色画点
  labs(x = "", y = "Enrichment Score", title = "") + 
  scale_x_continuous(expand = c(0, 0)) + #让x和y轴都从0开始
  scale_y_continuous(expand = c(0, 0),
                     limits =c(min(result$RUNNING.ES-0.02), max(result$RUNNING.ES+0.02))) + 
  theme_classic() + 
  theme(axis.line.x = element_blank(),axis.ticks.x = element_blank(),axis.text.x = element_blank()) + #去除x轴
  geom_hline(yintercept = 0) #在0的位置画x轴
ppoint
```

如果pathway不多，还可以把legend画在左下角

```{r, fig.height=4,fig.width=5}
ppoint2 <- ppoint + theme(legend.position=c(0,0),legend.justification = c(0,0)) + 
  guides(fill=guide_legend(title = NULL)) + #隐藏由fill产生的图例的title
  theme(legend.background = element_blank()) +
  theme(legend.key = element_blank())
ppoint2

#可以用ggsave保存到文件
#ggsave(file="ppoint2.pdf")
```

再画条码

散点图和后面的条码图本身就已经显示了gene rank，其实只有画线图的时候需要另外画gene rank。

```{r,fig.height=1,fig.width=4}
prank <- ggplot(result,aes(RANK.IN.GENE.LIST,pathway,colour=pathway))+
  geom_tile()+
  theme_bw() + #去除背景色
  scale_color_manual(values = mycol) + #用自定义的颜色画点
  labs(x = "treatment<--------------control", y = "", title = "") + 
  scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) +#让x和y轴都从0开始
  theme(panel.grid =element_blank()) + #去除网格线
  theme(panel.border = element_blank()) + #去除外层边框
  theme(axis.line = element_line(colour = "black"))+
  theme(axis.line.y = element_blank(),axis.ticks.y = element_blank(),axis.text.y = element_blank())+ #去除y轴
  guides(color=FALSE)#隐藏由color产生的图例
prank
```

组图

```{r,message=FALSE,warning=FALSE}
#用gridExtra保持上下两个图各自的高度
gA=ggplot_gtable(ggplot_build(ppoint)) #或ppoint2
gB=ggplot_gtable(ggplot_build(prank))
maxWidth = grid::unit.pmax(gA$widths, gB$widths)
gA$widths <- as.list(maxWidth)
gB$widths <- as.list(maxWidth)

#然后用grid组合两个图，按同一个x坐标上下对齐
grid.newpage()
grid.arrange(arrangeGrob(gA,gB,nrow=2,heights=c(.8,.3)))

# 输出到文件
pdf('prettyGSEApoint.pdf',width=8,height=4)
grid.arrange(arrangeGrob(gA,gB,nrow=2,heights=c(.8,.3)))
dev.off()
```

### 图二：线图（enrichment score） + 条码（rank）

先画线图

```{r,fig.height=4,fig.width=5}
pline <- ggplot(result,aes(x=RANK.IN.GENE.LIST,y=RUNNING.ES,colour=pathway,group=pathway))+
  geom_line(size=1) + 
  scale_color_manual(values = mycol) + #用自定义的颜色画点
  labs(x = "", y = "Enrichment Score", title = "") + 
  scale_x_continuous(expand = c(0, 0)) + #让x和y轴都从0开始
  scale_y_continuous(expand = c(0, 0),
                     limits =c(min(result$RUNNING.ES-0.02), max(result$RUNNING.ES+0.02))) + 
  theme_bw() + #去除背景色
  theme(panel.grid =element_blank()) + #去除网格线
  theme(panel.border = element_blank()) + #去除外层边框
  theme(axis.line = element_line(colour = "black")) +
  theme(axis.line.x = element_blank(),axis.ticks.x = element_blank(),axis.text.x = element_blank()) + #去除x轴
  geom_hline(yintercept = 0) + #在0的位置画x轴
  theme(legend.position=c(0,0),legend.justification = c(0,0)) + #legend画在左下角
  guides(colour=guide_legend(title = NULL)) + #隐藏由color产生的图例的title
  theme(legend.background = element_blank()) +
  theme(legend.key = element_blank())
pline
```

跟前面的条码图组图

```{r,message=FALSE,warning=FALSE}
#用gridExtra保持上下两个图各自的高度
gA=ggplot_gtable(ggplot_build(pline))#换成p1试试看
gB=ggplot_gtable(ggplot_build(prank))
maxWidth = grid::unit.pmax(gA$widths, gB$widths)
gA$widths <- as.list(maxWidth)
gB$widths <- as.list(maxWidth)

#然后用grid组合两个图，按同一个x坐标上下对齐
grid.newpage()
grid.arrange(arrangeGrob(gA,gB,nrow=2,heights=c(.8,.3)))

# 输出到文件
pdf('prettyGSEAline.pdf',width=5,height=4)
grid.arrange(arrangeGrob(gA,gB,nrow=2,heights=c(.8,.3)))
dev.off()
```

### 图三：条码（enrichment score + rank） + 热图

类似于散点图，同样要先把该通路中基因的enrichment score提取出来。

一次画一个，画到list里

```{r}
pbar <- lapply(unique(result$pathway), function(ii) {
    dd <- result[result$pathway == ii,]
    ggplot(dd,aes(x=RANK.IN.GENE.LIST,y=RUNNING.ES))+
      geom_bar(stat="identity",colour = "black")+
      labs(x = ii, y = "", title = ii) +
      theme_void() + #不画坐标系
      xlim(0, max(result$RANK.IN.GENE.LIST))
})
pbar
```

如果单画一条通路，那么这个热图应该画成有意义的。画多条就只能画这种假的了，仅用来表示左侧下调，右侧上调。

```{r,fig.height=1,fig.width=4}
t <- data.frame(a=as.numeric(1:1000),b=as.numeric(1:1000))

pheat <- ggplot(t,aes(a,1,fill=b)) +
  geom_tile()+
  theme_bw() + #去除背景色
  labs(x = "Decreased--------------Increased", y = "", title = "") + 
  scale_fill_gradient2(low = "blue", mid = "white", high = "red",midpoint = 500)+
  scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) +#让x和y轴都从0开始
  theme(panel.grid =element_blank()) + #去除网格线
  theme(panel.border = element_blank()) + #去除外层边框
  guides(fill=FALSE)#隐藏由fill产生的图例
pheat
```

用cowplot组图

```{r,message=FALSE,fig.height=5,fig.width=4}
pbar[[4]] <- pheat
plot_grid(plotlist=pbar, ncol=1,rel_heights = c(2,2,2,1))
ggsave("prettyGSEAbar.pdf")
```

```{r}
sessionInfo()
```