---
title: "FigureYa57 profile_1bw"
author: "小丫画图"
date: "2018-11-25"
output: html_document
---
微信ID: epigenomics  E-mail: figureya@126.com

作者：王童鞋

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

输入1个bw，多个bed，画出paper里的图。

![](example.png)

出自<https://www.nature.com/articles/nature19362>

## 应用场景

对比多个region在同一个sample里的信号特征。例如展示高CpG、低CpG区域的ChIP-seq信号强度差异。

如果需要对比不同的样品在某一区域的信号特征，请看FigureYa44profile。

## 参数设置

在这里修改常见的需要调整的参数

```{r}
#需要`corelib.R`文件里的函数提取bw文件里的信号
source("./corelib.R") #位于当前文件夹

outputName <- "multiSitepro_example.pdf" #输出的pdf文件名
bigWigFile <- c("8cell.K4me3.bw") #bw文件，位于当前文件夹
bedFiles <- c("mm9_HCP_tss.bed","mm9_ICP_tss.bed","mm9_LCP_tss.bed") #bed文件，位于当前文件夹
labels <- c("HCP","ICP","LCP") #图例标签，跟bed数量一致
siteType <- "TSS"
resolution <- 10 #分辨率，数值越低，画出来的曲线越平滑，运行时间越长
span <- 2000 #gene body normalization length，需要是resolution的整数倍
coreNumber <- detectCores() - 1 #留出一个核用来干别的事情
normalization_constant <- 1 #均一化的系数，根据展示所需信号值刻度调整
colors <- c("darkorange","navy","darkgreen") #线的颜色，跟bed数量一致

#如果对自己的电脑有信心，就改为0，不sampling
sampling_number <- 5000 #0 for no sampling, smaller than each bed rows
```

## 输入文件

8cell.K4me3.bw：ChIP/DNase/ATAC-seq的bw文件

mm9_HCP_tss.bed, mm9_ICP_tss.bed, mm9_LCP_tss.bed：用来提取bw信号的指定区域。其中第1、2、3、6列必需。

## 信号提取

```{r}
average_signal <- c()
for(i in 1:length(bedFiles)){
  
  # load bed file
  bed <- read.table(bedFiles[i])
  isNormalChrosome <- !grepl("_",bed$V1)
  bed <- bed[isNormalChrosome,]
  
  # sampling
  if(sampling_number != 0){
    set.seed(6666)
    idx <- sample(1:nrow(bed),size=sampling_number)
   bed <- bed[idx,]
  }

  # caputre signal
  average_signal <- rbind(average_signal,signal_caputer_around_sites(bigWigFile,bed,resolution=resolution,span=span,cores=as.integer(coreNumber)))
}
average_signal <- average_signal / normalization_constant

#这步比较耗时，我们把抽取的信号保存到`average_signal.txt`文件里。
write.table(average_signal,"average_signal.txt",quote = F,row.names = F,col.names = F)
```

## 开始画图

```{r, fig.width=4, fig.height=4}
average_signal <- read.table("average_signal.txt", header = F, as.is = T)
minimum <- min(average_signal) - (max(average_signal) - min(average_signal)) * 0.1
maximum <- max(average_signal) + (max(average_signal) - min(average_signal)) * 0.1 * length(bedFiles)

datapoints <- span / resolution

#pdf(outputName,width = 4, height = 4)
plot(1:(datapoints * 2 + 1), average_signal[1,], 
     type = "l", lwd = 3, col = colors[1],
     xaxt = "n", #不显示x轴刻度
     xlab="Distance to TSS", ylab="Normalized signal", 
     ylim = c(minimum, maximum))

for(i in 2:length(bedFiles)){
  lines(1 : (datapoints*2+1), average_signal[i,], 
        lwd = 3, col = colors[i]) #线的颜色、粗细
}

legend("topright", col=colors, 
       legend = labels, lty = 1, lwd = 3,
       bty = "n") #不显示图例边框

box(lwd = 2) #边框粗细

axis(side=1, at=c(0, datapoints, datapoints*2) + 1, labels = c(paste(-1*span/1000, "kb"), siteType, paste(span/1000, "kb")))
#dev.off()
```

```{r}
sessionInfo()
```