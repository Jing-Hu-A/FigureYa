# 工作流名称
name: Test Render First 3 Rmd Files

# 触发条件：可以手动触发
on:
  workflow_dispatch:

jobs:
  test-render:
    runs-on: ubuntu-latest
    # 关键点1：授予工作流向仓库写入内容的权限
    permissions:
      contents: write
    
    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      - name: 2. Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.2'

      - name: 3. Install core R dependencies
        run: Rscript -e 'install.packages(c("rmarkdown", "knitr"))'

      - name: 4. Find and Render the first 3 Rmd files
        run: |
          echo "RMD Render Summary (First 3 Files)" > summary.txt
          echo "======================================" >> summary.txt
          echo "" >> summary.txt

          find . -type f -name "*.Rmd" | head -n 3 | while read rmd_file; do
            echo "--- Processing: $rmd_file ---"
            
            if Rscript -e "rmarkdown::render('$rmd_file')"; then
              echo "[SUCCESS] - $rmd_file" >> ../summary.txt
            else
              echo "[FAILED] - $rmd_file" >> ../summary.txt
            fi
            echo "--- Finished: $rmd_file ---"
            echo ""
          done

      - name: 5. Upload Render Summary
        # 我们仍然保留这个报告，方便调试
        uses: actions/upload-artifact@v4
        with:
          name: render-summary-report-first-3
          path: summary.txt

      - name: 6. Commit and Push Rendered Files
        # 关键点2：将生成的文件提交回仓库
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          # 检查是否有文件被修改或新增，如果有，才执行提交
          if ! git diff --staged --quiet; then
            git commit -m "docs: Auto-render Rmd output files by GitHub Actions"
            git push
          else
            echo "No changes to commit."
          fi
