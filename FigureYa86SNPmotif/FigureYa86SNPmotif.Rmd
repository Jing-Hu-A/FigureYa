---
title: "FigureYa86SNPmotif"
author: "小丫画图出品"
date: "2019-4-7"
output: html_document
---
欢迎关注“小丫画图”公众号，回复“小白”，看小视频，实现点鼠标跑代码。

小丫微信: epigenomics  E-mail: figureya@126.com

作者：小丫

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

突变会影响转录因子结合吗？作出判断，并同时画出motif logo和SNP的图。

![](example.png)

出自<http://cancerres.aacrjournals.org/content/77/7/1649>

# 应用场景

在基因组上同时展示突变位点和motif，为突变影响转录因子结合提供量化（pvalue、score）和可视化的证据。

在“小丫画图”公众号回复“SNP”，查看这个图在更多paper里的应用。

运行下面这行，查看motifbreakR的官方手册

```{r eval=FALSE}
browseVignettes("motifbreakR")
```

motifbreakR还可以跟其他工具结合使用，一系列结果图作为证据，帮你充实文章。看这篇：[Variant Annotation Workshop with FunciVAR, StateHub and MotifBreakR](https://www.simoncoetzee.com/bioc2017.html)

# 环境设置

使用国内镜像安装包

```{r eval=FALSE}
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.tuna.tsinghua.edu.cn/bioconductor/")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("motifbreakR")

#如果你只提供rs ID，就需要安装这个包
#SNP locations and alleles for Homo sapiens extracted from NCBI dbSNP Build 151. The source data files used for this package were created by NCBI between February 16-22, 2018, and contain SNPs mapped to reference genome GRCh38.p7
#这个版本的SNP文件480M，其他版本更大，建议下载后本地安装，<http://bioconductor.org/packages/3.8/data/annotation/src/contrib/SNPlocs.Hsapiens.dbSNP142.GRCh37_0.99.5.tar.gz>
BiocManager::install("SNPlocs.Hsapiens.dbSNP142.GRCh37")

#如果你提供bed或vcf，有下面这个包就够了
#Full genome sequences for Homo sapiens (Human) as provided by UCSC (hg19, Feb. 2009) and stored in Biostrings objects.
BiocManager::install("BSgenome.Hsapiens.UCSC.hg19")
```

其他物种到<http://www.bioconductor.org/packages/3.8/data/annotation>查找相应的包的名字。

你的电脑可能需要安装GhostScript，参考<https://github.com/Simon-Coetzee/motifBreakR>里的Prepairing to install

加载包

```{r}
library(motifbreakR)
library(SNPlocs.Hsapiens.dbSNP142.GRCh37)
library(BSgenome.Hsapiens.UCSC.hg19)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

# 输入数据

motifbreakR可以用SNP的rs ID，或bed文件，或vcf文件作为输入。

## 提供SNP的rs ID

输入文件可以只提供SNP的rsID，例如rs1006140

```{r}
#SNPID <- read.table("easy_input_rs.txt")$V1
#SNPID
SNPID <- "rs1927914"
SNPinfo <- snps.from.rsid(rsid = SNPID, 
                           dbSNP = SNPlocs.Hsapiens.dbSNP142.GRCh37, 
                           search.genome = BSgenome.Hsapiens.UCSC.hg19)
SNPinfo
```

## 提供突变位点的bed或vcf文件

easy_input.bed，整理自例文里的Table S1

```{r eval=FALSE}
SNPinfo <- snps.from.file(file = "easy_input.bed", #输入文件
                                  search.genome = BSgenome.Hsapiens.UCSC.hg19,
                                  format = "bed") #或vcf
```

# 判断SNP对motif的影响

```{r}
results <- motifbreakR(snpList = SNPinfo, filterp = TRUE,
                       pwmList = hocomoco,
                       threshold = 1e-4,
                       method = "ic",
                       bkg = c(A=0.25, C=0.25, G=0.25, T=0.25),
                       BPPARAM = BiocParallel::bpparam())

#提取其中一个突变位点的结果
result1 <- results[names(results) %in% "rs1927914"]
#去除重复的行
result1 <- unique(result1)
#计算p value
result1pval <- calculatePvalue(result1)
result1pval
#计算例文图中motif右侧的分数，Altscore-Refscore
result1pval$score <- result1pval$scoreAlt-result1pval$scoreRef
#把计算结果保存到文件
write.csv(result1pval, "output.csv", quote = F)
```

# 开始画图

```{r}
#pdf("SNPmotif.pdf")
#grid.newpage()
plotMB(results = result1, rsid = "rs1927914", 
       effect = "strong") #或weak
#dev.off()
```

# 后期加工

根据output.csv中的最后一列score，向图中添加每个转录因子的Altscore-Refscore

```{r}
sessionInfo()
```