---
title: "FigureYa11bubbles"
author: "小丫画图出品"
date: "2018-6-10"
output: html_document
---
欢迎关注“小丫画图”公众号，回复“小白”，看小视频，实现点鼠标跑代码。

微信ID: epigenomics  E-mail: figureya@126.com

作者：小丫

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
用R代码画出paper里的基因功能富集分析泡泡图，按对角线排列很好看

热图用代码9解决，本代码解决泡泡图

![](example.png)

# 使用场景

场景一：展示基因功能富集分析的结果

场景二：多维度的数据信息展示

# 环境设置

使用国内镜像安装包

```{r}
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")

```

加载包

```{r}
library(ggplot2)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

# 输入数据

例文左半部分是下调表达的基因，右侧是上调表达的基因。

我们这里都用easy_input.txt文件，实际应用时，替换成你的富集分析结果即可。

至少包括：Term、Pvalue、number of genes in group(test, Pop.Hits)，number of annotated gene(background, Count)或者Gene Ratio(test/background)

```{r}
df <- read.table("easy_input.txt", header = T, sep = "\t", as.is = T)
head(df)
# 算一下gene ratio
df$GeneRatio <- df$Pop.Hits/df$Count
```

# 开始画图

例图横坐标是GeneRatio，点的大小是组内基因数量，颜色代表pvalue。

实际应用时，可以把横坐标、颜色或点的大小所代表的特征值改为你想要的其他列。

```{r, fig.height=6, fig.width=8}
# 查看GeneRatio的最大值和最小值，可以用来确定合理的x轴范围
summary(df$GeneRatio)

# 为了画出对角线排列的效果，按GeneRatio排序
sortdf <- df[order(df$GeneRatio), ] #如果想按Pvalue排序，就把GeneRatio改为PValue
sortdf$Term <- factor(sortdf$Term, levels = sortdf$Term)

pl <- ggplot(sortdf, aes(GeneRatio, Term, #横坐标、纵坐标
              colour = PValue)) + # 颜色代表p-value
  geom_point(aes(size= Count)) + #圆点的大小代表组内基因数
  scale_size_continuous(range = c(2,10)) + #圆点的大小范围
  scale_color_gradientn(colours=c("red", "yellow")) + #可以自己改颜色
  #scale_x_continuous(limits = c(0.2,1)) + #设置x轴范围
  theme_bw() + 
  ylab("") + 
  theme(legend.position=c(1,0), legend.justification = c(1, 0)) + #legend画在右下角
  #下面两行让legend融入图
  theme(legend.background = element_blank()) + #移除legend整体的边框
  theme(legend.key = element_blank())#移除legend每个项目周围的边框
pl

ggsave("dot.pdf", width = 7, height = 6)
# 还可以直接保存为png、tiff等格式
#ggsave("dot.png", width = 7, height = 6)
#ggsave("dot.tiff", width = 7, height = 6)
```

想按相反的方向排序，只需在排序的时候加上decreasing = T

把term放到右侧，添加scale_y_discrete(position = "right")

```{r, fig.height=6, fig.width=8}
sortdf <- df[order(df$GeneRatio, decreasing = T), ] #降序
sortdf$Term <- factor(sortdf$Term, levels = sortdf$Term)

pr <- ggplot(sortdf, aes(GeneRatio, Term, 
              colour=PValue)) + 
  geom_point(aes(size=Count)) + 
  scale_color_gradientn(colours=c("red", "yellow")) + 
  scale_size_continuous(range = c(2, 10)) + 
  #scale_x_continuous(limits = c(0.2, 1)) + 
  ylab("") + 
  scale_y_discrete(position = "right") + #把term放到右侧
  
  theme_bw() + 
  theme(legend.position=c(0, 0), legend.justification = c(0, 0)) + #legend画在左下角
  theme(legend.background = element_blank()) + 
  theme(legend.key = element_blank())
pr
```

把两个图并排组合到一起

```{r, fig.height=6, fig.width=15}
library(cowplot)
plot_grid(pl, pr, labels = "")
ggsave(file="bubbles.pdf")
```

# SessionInfo

```{r}
sessionInfo()
```