FigureYa149rankHeatmap
FigureYa149rankHeatmap
小丫画图出品
2019-11-24
Author: Hao Li
Reviewer: Ying Ge, Junyi Shen
需求描述 Description of requirements
分类变量的热图。 Heat maps of categorical variables.
出自 From
https://bmccancer.biomedcentral.com/articles/10.1186/s12885-019-5768-0
Fig. 1 Differential gene expression of 24 matrix metalloproteinases (MMPs) in 15 different cancer types. Fold change and p-values shown were obtained through comparison of
unmatched control tissue (N between 11 and 114) to tumor tissue
(N between 66 and 1097). Fold change was calculated as the median expression of a gene in tumor divided by the median gene expression in adjacent normal tissue.
图的解读 Interpretation of the figure
每行一个基因，每列一个癌症类型 One gene per row, one cancer type per column
颜色分为6档：5档变化倍数（红色上调，蓝色下调）和pvalue不显著（白色） The color is divided into 6 levels: 5 levels of change (red up, blue down) and pvalue is not significant (white)
如果pvalue>0.05，无论变化倍数多大都是白色 If the pvalue > 0.05, it is white regardless of the change multiple
白色和灰色时，字为黑色；蓝色和红色时，字为白色。 When white and gray, the words are black; When blue and red, the words are white.
应用场景 Application scenarios
展示某些基因差异表达结果的时候，经常是把连续性变量当作数值来直接进行热图绘制。也可以像例文那样，先设置成分类变量的，同时用数字来进一步注释。变成分类变量后，可能更清晰的看到趋势。 When showing the differential expression results of certain genes, continuous variables are often used as values to directly heat map. You can also set it as a categorical variable first, as in the example, and use numbers to further annotate. After becoming a categorical variable, you may see the trend more clearly.
还可以用来转换和展示相关性或其他连续变量。 It can also be used to transform and demonstrate correlations or other continuous variables.
这里用complexheatmap画图，其实还可以用pheatmap画图，可参考FigureYa114ternaryCluster，按表达量分为3组（高/低/不变）来画图。 You can refer to FigureYa114ternaryCluster, which is divided into 3 groups (high/low/unchanged) according to the amount of expression.
环境设置 Environment settings
使用国内镜像安装包 Use the domestic mirror installation package
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
加载包 Load the package
library(ComplexHeatmap)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 Displays the error message in English
options(stringsAsFactors = FALSE) #禁止chr转成factor
Prohibiting CHR from converting to factor
输入文件 Enter the file
easy_input_logFc.csv，差异表达分析当中的
logFC
值，还可以替换为相关分析的相关系数。 easy_input_logFc.csv, the logFC value in the differential expression analysis can also be replaced with the correlation coefficient of the correlation analysis.
easy_input_PVal.csv，差异表达分析当中的
P
值。 easy_input_PVal.csv,
the P
value in the differential expression analysis.
genetype.csv，基因的分组，用于画最左侧annotation，非必须。 genetype.csv, the grouping of genes is used to draw the leftmost annotation, which is not necessary.
logfc <- read.csv("easy_input_logFc.csv", row.names = 1)
logfc[1:2,]
p.val <- read.csv("easy_input_PVal.csv", row.names = 1)
p.val[1:2,]
genetype <- read.csv("genetype.csv")
head(genetype)
#为确保热图基因的顺序和分组文件的顺序是一致的 To ensure that the order of the heatmap genes is consistent with the order of the grouping file
#因此按照基因分组文件里的顺序，对logfc和p.val两个文件排序 Therefore, the logfc and p.val files are sorted according to the order in the genome grouping file
logfcOrdered <- logfc[genetype$gene,]
p.valOrdered <- p.val[genetype$gene,]
连续变量转换为分类变量 Continuous variables are converted to categorical variables
分类规则： Classification rules:
先按logFC值分成
5类
； First, it is divided into 5 categories according to the logFC value.
如果
pvalue>0.05
，无论倍数多大都作为第6类。 If the pvalue > 0.05, it is classified as class 6 regardless of the multiple.
开始画图 Start drawing
我们使用
ComplexHeatmap
绘图，分三步： We use ComplexHeatmap to draw in three steps:
用转换好的
logfcCat
数据集定义热图的颜色； Define the color of the heatmap with the transformed logfcCat dataset;
在每个热图框中添加数字，由于黑色的数字在深颜色当中不清楚，所以会根据不同的不同的cutoff调整数字的颜色； Add numbers to each heatmap box, because the black numbers are not clear in the dark colors, so the color of the numbers will be adjusted according to different cutoffs;
添加左侧分类注释； Add left-side classification notes;
画图。 Drawing.
1. 定义好每个分类变量的颜色 Define the color of each categorical variable
2. 自定义一个字体颜色根据cutoff变化的函数 Customize a function that changes the font color according to the cutoff
热图颜色为白色和灰色时，字为黑色；蓝色和红色时，字为白色。 When the heat map colors are white and gray, the words are black; When blue and red, the words are white.
所以我们就定义了一个包含两个数据集的函数 So we define a function that contains two datasets
cell_fun <- function(logfc, dataP, logfcCutoff = 1, PCutoff = 0.05, 
                     darkcol = "black", lightcol = "white", digit = 2, fontsize  = 6){
    function(j, i, x, y, width, height, fill){
        if(abs(logfc[i,j]) > logfcCutoff & dataP[i,j] < PCutoff){
            grid.text(round(logfc, digit)[i, j], x, y, 
                      gp = gpar(fontsize = fontsize, col  = lightcol))
        }else{
            grid.text(round(logfc, digit)[i, j], x, y, 
                      gp = gpar(fontsize = fontsize, col  = darkcol))
        }
    }
}
函数的参数包括 The parameters of the function include:
logfc: logfc的数据集 logfc: A dataset of logfc
dataP: P值的数据集 dataP: A dataset of P values
logfcCutoff和PCutoff的cutoff值 logfcCutoff and PCutoff cutoff values
darkcol和lightcol：浅色和深色的字体颜色 Darkcol and Lightcol: Light and dark font colors
digit: 热图框当中显示数据的小数点位数 digit: The number of decimal places in the heatmap box that displays the data
fontsize: 热图框内字体颜色的大小 fontsize: The size of the font color within the heatmap frame
3. 添加注释 Add a note
热图的旁边会有一个对于基因的注释。我们需要对注释信息进行定义 The heatmap will have a note next to the gene. We need to define the annotation information
Annotate rows or columns
4. 统一绘图 Unified drawing
最后我们把所有的数据结合到一起来绘图即可 Finally, we can combine all the data together to draw
pdf("rankHeatmap.pdf", width = 8, height = 4)
Heatmap(matrix = logfcCat, 
        name = "logFC", #主要图例的标题 The title of the main legend
        rect_gp = gpar(col = "NA", lwd = 1), #不画边框，或者用col = "grey"画灰色边框 Draw no border, or draw a gray border with col = "grey"
        col = col_cat, #热图颜色 Heatmap colors
        row_names_side = "left", 
        cell_fun = cell_fun(logfcOrdered, p.valOrdered), 
        row_names_gp = gpar(fontsize = 8), #基因名字号 Gene name
        column_names_gp = gpar(fontsize = 8), #肿瘤类型字号 tumor type font size
        column_names_rot = 45, #肿瘤类型呈45度 The tumor type is 45 degrees
        left_annotation = row_an) #左侧基因分类，如果不画，就筛掉这个参数 Left gene classification, if not drawn, filter out this parameter
dev.off()
sessionInfo()