---
title: "FigureYa55plus_pancancer_boxplot"
author: "小丫画图出品"
date:  "2020-7-1"
output: html_document
---
欢迎关注“小丫画图”公众号，回复“小白”，看小视频，实现点鼠标跑代码。

小丫微信: epigenomics  E-mail: figureya@126.com

作者：Chris Lou

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

小伙伴问：感谢小丫带我们打开xena魔盒，有一个问题，FigureYa55pancancer_violin的图能不能画成box plot？

小丫答：可参考FigureYa12box的画法，能让R水平上一个台阶。

问：懒，能不能用FigureYa55pancancer_violin的输出文件easy_input.csv作为输入，直接画出boxplot？想要无缝对接。

答：能。感谢Chris Lou帮忙更新，分享两个版本的解决方案：ggpubr版和纯ggplot2版

# 环境设置

```{r}
Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

# 输入文件

easy_input.csv，每行一个sample。第一列组织部位，第二列肿瘤/对照组，第三列基因表达量。

将为每种组织部位计算肿瘤vs.对照之间的p value，在图中用/*标注。

> 怎样获得这个输入文件？

FigureYa55pancancer_violin带你从xena下载数据开始，到提取基因在33种癌症中的表达量。不怕TCGA的normal太少，用GTEx的正常组织作为对照，输出easy_input.csv文件。

```{r}
tcga_gtex <- read.csv("easy_input.csv", row.names = 1, header = T, as.is = F)
head(tcga_gtex)
```

# 开始画图

## 方法一：ggpubr

```{r fig.width=15, fig.height=5}
library(ggpubr)

ylabname <- paste("TP53", "expression")
colnames(tcga_gtex) <- c("Tissues", "Groups", "Gene")

p1 <- ggboxplot(tcga_gtex, x = "Tissues", y = "Gene", fill = 'Groups',
                ylab = ylabname,
                color = "Groups", #两组用不同颜色
                palette = "jco", #配色方案
                ggtheme = theme_minimal())
p1

# 画box的同时画散点
p2 <- ggboxplot(tcga_gtex, x = "Tissues", y = "Gene", fill = 'Groups',
                ylab = ylabname,
                color = "Groups", 
                palette = "jco", 
                add = "jitter", #加散点
                #shape = "Groups", #两组散点用不同形状
                ggtheme = theme_minimal())
p2

# 标注p value
anno_df <- compare_means(Gene ~ Groups, group.by = "Tissues", data = tcga_gtex,
                         #这里是两组对比，用wilcox.test或t.test
                         method = "wilcox.test", 
                         #如果多组对比就用下面这行，kruskal.test或anova
                         #method = "kruskal.test", 
                         p.adjust.method = "holm") #
head(anno_df)

p3 <- p2 + 
  stat_pvalue_manual(anno_df, x = "Tissues", y.position = 15,
                     label = "p.signif", position = position_dodge(0.8))
p3
ggsave("pancancer_ggpubr.pdf", width = 14, height = 5)
```

## 方法二：ggplot2

用ggplot2自己画，更灵活。

```{r fig.width=15, fig.height=5}
library(ggplot2)

ylabname <- paste("TP53", "expression")
colnames(tcga_gtex) <- c("Tissues", "Groups", "Gene")

# 剔除没有normal sample的tissue
tcga_gtex_MESO <- tcga_gtex[tcga_gtex$Tissues=="MESO",]
tcga_gtex_UVM <- tcga_gtex[tcga_gtex$Tissues=="UVM",]
tcga_gtex_withNormal <- tcga_gtex[tcga_gtex$Tissues != "MESO" & tcga_gtex$Tissues != "UVM",]

# 计算p value
pvalues <- sapply(tcga_gtex_withNormal$Tissues, function(x) {
  res <- wilcox.test(as.numeric(Gene) ~ Groups, data = subset(tcga_gtex_withNormal, Tissues == x)) #两组，wilcox.test或t.test；多组，kruskal.test或aov(one-way ANOVA test)
  res$p.value
})

pv <- data.frame(gene = tcga_gtex_withNormal$Tissues, pvalue = pvalues)
pv$sigcode <- cut(pv$pvalue, c(0,0.0001, 0.001, 0.01, 0.05, 1), 
                  labels=c('****','***', '**', '*', 'ns'))

# 画box plot
p.box <- ggplot(tcga_gtex_withNormal, aes(x=Tissues, y=Gene, color=Groups, fill=Groups)) +
  geom_boxplot(alpha = .5) + #半透明
  theme_classic() + #或theme_bw()
  scale_fill_brewer(palette = "Set1") + #按类填充颜色
  scale_color_brewer(palette = "Set1") + #按类给边框着色

  theme(axis.text.x = element_text(colour="black", size = 11,
                                   #癌症名太挤，旋转45度
                                   angle = 45, hjust = .5, vjust = .5)) +
  geom_text(aes(x=gene, y=max(tcga_gtex_withNormal$Gene) * 1.1,
                         label = pv$sigcode),
                     data=pv, 
                     inherit.aes=F) +
  ylab(ylabname)
p.box
ggsave("pancancer_ggplot2box.pdf", width = 14, height = 5)

# 画带散点的box plot
p.box.dot <- p.box + geom_point(shape = 21, size=.5, # 点的形状和大小
             position = position_jitterdodge(), # 让点散开
             alpha = .5) #半透明
p.box.dot
ggsave("pancancer_ggplot2boxDot.pdf", width = 14, height = 5)

# 把不带normal的tissue也画上
p.box.dot + 
  # MESO
  geom_boxplot(alpha = .5, data = tcga_gtex_MESO,
                     mapping = aes(x=Tissues,y=Gene,fill=Groups)) +
  geom_point(data = tcga_gtex_MESO,
                     mapping = aes(x=Tissues,y=Gene,fill=Groups),
             shape = 21, size=.5, # 点的形状和大小
             position = position_jitterdodge(), # 让点散开
             alpha = .5) + #半透明
  # UVM
  geom_boxplot(alpha = .5, data = tcga_gtex_UVM,
                    mapping = aes(x=Tissues,y=Gene,fill=Groups)) +
  geom_point(data = tcga_gtex_UVM,
                    mapping = aes(x=Tissues,y=Gene,fill=Groups),
             shape = 21, size=.5, # 点的形状和大小
             position = position_jitterdodge(), # 让点散开
             alpha = .5) + #半透明
  theme_classic() + #或theme_bw()
  theme(axis.text.x=element_text(colour="black", size = 11,
                                   angle = 45, hjust = .5, vjust = .5))
ggsave("pancancer_ggplot2boxDot_all.pdf", width = 14, height = 5)
```

# Session Info

```{r}
sessionInfo()
```