---
title: "FigureYa121MethCGIcluster"
author: "小丫画图出品"
date: "2019-7-28"
output: html_document
---
欢迎关注“小丫画图”公众号，同名知识星球等你加入

小丫微信: epigenomics  E-mail: figureya@126.com

作者：大鱼海棠

单位：Research Center of Biostatistics and Computational Pharmacy, China Pharmaceutical University

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

用DNA甲基化数据做分型，画出这个图。

![](example.png)

出自<https://link.springer.com/article/10.1007%2Fs00401-018-1854-7>

## 应用场景

DNA甲基化450k数据挑选出CpG位点，然后取高变异的探针，做无监督聚类分子分型。

可用于挖掘TCGA的DNA甲基化数据。

## 环境设置

使用国内镜像安装包

```r
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
BiocManager::install("ChAMP")
```

加载包

```{r}
library(data.table)
library(ChAMP)
library(ClassDiscovery)
library(pheatmap)
library(gplots)
library(ComplexHeatmap)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

## 输入文件的准备

- HumanMethylation450.gz，甲基化由于数据庞大，这里选择了TCGA中样本量比较小的子宫肉瘤UCS为示例

数据于XENA平台下载，进入<https://xenabrowser.net/datapages/>，点击你感兴趣的癌症。此处以UCS为例，因此点击GDC TCGA Uterine Carcinosarcoma (UCS) (12 datasets)，点击DNA methylation下Illumina Human Methylation 450 (n=57) GDC Hub，<https://xenabrowser.net/datapages/?dataset=TCGA.UCS.sampleMap%2FHumanMethylation450&host=https%3A%2F%2Ftcga.xenahubs.net&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>，点击download右侧的链接，下载得到HumanMethylation450.gz，解压到当前文件夹，无后缀名

- easy_input_age.txt，年龄，非必需，仅用于模仿例文的图，还可以是其他数据，可参考FigureYa71ssGSEA获得临床信息。

```{r}
# 读取原始甲基化谱
orgmeth <- fread("HumanMethylation450") # 用fast read快速读取大文件
orgmeth <- as.data.frame(orgmeth); rownames(orgmeth) <- orgmeth[,1]; orgmeth <- orgmeth[,-1]
orgmeth[1:3,1:3]

# 模拟年龄(注意这是模拟数据)
#Sinfo <- data.frame(age = floor(runif(ncol(orgmeth),min = 30,max = 60)),row.names = colnames(orgmeth),stringsAsFactors = F)
#write.table(Sinfo, "easy_input_age.txt", sep = "\t", quote = F)

# 读取年龄
Sinfo <- read.table("easy_input_age.txt", header = T, row.names = 1)
head(Sinfo)
```

## 挑选出CpG位点

利用champ包做探针过滤，探针主要包括CpG、XY染色体和SNPs，我们只保留CpG位点。

**题外话：**champ包功能强大，尤其是在差异甲基化功能富集上，感兴趣的小伙伴可以自行学习

```{r}
myFilter <- champ.filter(beta           = orgmeth, # beta矩阵
                         pd             = NULL,    # 样本信息，因为仅利用champ做探针过滤，所以没有必要给出
                         # 以下过滤是根据众筹提供的参考文献46来的，主要就是过滤CpG，SNPs以及XY
                         autoimpute     = F,       # 不填补缺失值
                         filterDetP     = F,       # 不根据探针p值过滤
                         fixOutlier     = F,       # 不修正离群点 (没有pd信息这里设置T会报错)
                         filterMultiHit = T,       # 移除对位点比对的探针
                         filterNoCG     = T,       # 仅保留CpG位点
                         filterSNPs     = T,       # 移除含有snp的位点
                         filterXY       = T,       # 移除性染色体上的探针
                         arraytype      = "450K")  # 平台为450k
dim(myFilter$beta)

### 挑选感兴趣区域（启动子CpG Island） ###

# 如果需要筛选一些特定区域的探针，可以加载如下注释文件并获得注释信息，并挑选感兴趣的探针
# 比如这里挑选启动子CpG Island探针
library(IlluminaHumanMethylation450kanno.ilmn12.hg19)
data("IlluminaHumanMethylation450kanno.ilmn12.hg19")
anno <- getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)
prompb <- rownames(anno[which(anno$Relation_to_Island == "Island" & grepl("TSS",anno$UCSC_RefGene_Group)),])

indata <- myFilter$beta[prompb,]
```

## 取高变异的探针（此处取2500个）

```{r}
k <- 2500 # top k 个探针
var <- apply(indata, 1, sd)
var <- sort(var,decreasing = T)
topcgimeth <- indata[names(var[1:k]),]
topcgimeth[1:3,1:3]
```

## 无监督分子分型

```{r}
hcg <- hclust(distanceMatrix(t(topcgimeth), "euclidean"), "ward.D") # 可参照distanceMatrix的资料更换其他distance和linkage方法
gc() # 释放内存
hcs <- hclust(distanceMatrix(topcgimeth, "euclidean"), "ward.D")
group <- cutree(hcs,3) #此处分为3组
group <- paste0("C",as.character(group)); names(group) <- colnames(topcgimeth)
```

## 开始画图

这里提供两种画法：

- 画法一用pheatmap，简单易用，如果不画age，这个就够了。
- 画法二用complexheatmap，复现原图。

### 画法一：pheatmap

```{r}
### 设置颜色 ###
blue   <- "#5bc0eb"
yellow <- "#fde74c"
green  <- "#9bc53d"

# 绘制热图（可参照FigureYa91cluster_heatmap）
annCol <- data.frame(MethClust = group, row.names = names(group),stringsAsFactors = F)
annColors <- list("Methylation group" = c("C1" = blue,
                                          "C2" = green,
                                          "C3" = yellow))
pheatmap(topcgimeth,
         color = bluered(64),
         cluster_rows = hcg,
         cluster_cols = hcs,
         cutree_cols = 3,
         annotation_col = annCol,
         annotation_colors = annColors,
         show_rownames = F,show_colnames = F,
         filename = "methylation_cgi_clustering_pheatmap.pdf")
```

![](methylation_cgi_clustering_pheatmap.pdf)

### 画法二：complexheatmap

```{r}
# 产生顶部注释
column_ha <- HeatmapAnnotation(df =  data.frame(MethClust = as.character(group[colnames(topcgimeth)]) # 类注释
                                               ,row.names = colnames(topcgimeth)),
                              col = list("MethClust" = c("C1"="steelblue","C2"="red","C3"="grey40")), # 类颜色
                              age = anno_points(as.numeric(Sinfo$age),axis_param =  # 年龄注释
                                                  list(side = "left",
                                                       at = c(30, 40, 50),
                                                       labels = c("30","40","50"))),
                              height = unit(2.7, "cm"),
                              show_annotation_name = T)

hm <- Heatmap(topcgimeth, 
              name = "CpG methylation level",
              col = bluered(64), # 热图填充的颜色
              cluster_columns = hcs, # 列聚类
              cluster_rows = hcg, # 行聚类
              show_column_names = F, # 不显示列名
              show_row_names = F, # 不显示行名
              top_annotation = column_ha) # 顶部注释

pdf("methylation_cgi_clustering_complexheatmap.pdf",width = 8,height = 7)
draw(hm)
invisible(dev.off())
```

![](methylation_cgi_clustering_complexheatmap.pdf)

```{r}
sessionInfo()
```