---
title: "FigureYa25Sankey_update"
author: "小丫画图出品"
date: "2020-8-20"
output: html_document
---
欢迎关注“小丫画图”公众号，回复“小白”，看小视频，实现点鼠标跑代码。

微信ID: epigenomics  E-mail: figureya@126.com

作者：贝塔猫

更新：大鱼海棠

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
用R代码画出paper里的图。

![](example.png)

出自<https://www.nature.com/articles/nature22973>

# 应用场景

一套数据集可能有多重属性，每层属性之间有交叉，就可以用这种图来展示。另外，以第一变量为参照，往后的多层变量均参考与第一变量的关系，从而展示第一变量的流向。

- 场景一：一个group包含多个基因，同一个基因的不同突变可能属于多个group。像例图一样，展示高频突变基因所处的分组。

原文：Graphical summary of the most frequently mutated genes (≥10 affected cases) and their subgroup distribution.

... many of which showed clear subgroup-specificity (Fig. 2a–c; Extended Data Fig. 3a, b; Supplementary Table 2). 

- 场景二：miRNA和靶基因的关系，可参考群里小伙伴的用法：<https://onlinelibrary.wiley.com/doi/full/10.1002/jcp.28522>

- 场景三：人群按性别、年龄、家族史等特征分组，展示不同分组得癌症的规律。

# 环境设置

```{r}
#使用国内镜像安装包
#options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
#install.packages("ggalluvial")

library(ggalluvial)
library(dplyr)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

# 输入数据

easy_input.txt，至少要有两列，想画出几列就提供几列数据。此处第一列是基因，第二列是突变，第三列是癌症亚型；想画更多层次关系就继续向后添加列。

或者只写两列，第一列是miRNA，第二列是它的靶基因。

```{r}
df <- read.table("easy_input.txt",sep = "\t",row.names = 1,header = T)
head(df)

#定义足够多的颜色，后面从这里选颜色
mycol <- rep(c("#223D6C","#D20A13","#FFD121","#088247","#11AA4D","#58CDD9","#7A142C","#5D90BA","#029149","#431A3D","#91612D","#6E568C","#E0367A","#D8D155","#64495D","#7CC767"),2)
```

# 开始画图

两种方式展示前后关系：

- 后一层继承前一层的关系；
- 后面多层继承第一层的关系。

## 后一层继承前一层的关系

```{r,fig.width=6,fig.height=6}
#格式转换
UCB_lodes <- to_lodes_form(df[,1:ncol(df)],
                           key = "Gene",
                           axes = 1:ncol(df),
                           id = "Cohort")
dim(UCB_lodes)
head(UCB_lodes)
tail(UCB_lodes)

ggplot(UCB_lodes,
       aes(x = Gene, stratum = stratum, alluvium = Cohort,
           fill = stratum, label = stratum)) +
  scale_x_discrete(expand = c(0, 0)) + 
  geom_flow(width = 1/8) + #线跟方块间空隙的宽窄
  geom_stratum(alpha = .9,width = 1/10) + #方块的透明度、宽度
  geom_text(stat = "stratum", size = 3, color="black") + #文字大小、颜色
  
  #不喜欢默认的配色方案，用前面自己写的配色方案
  scale_fill_manual(values = mycol) +

  xlab("") + ylab("") +
  theme_bw() + #去除背景色
  theme(panel.grid =element_blank()) + #去除网格线
  theme(panel.border = element_blank()) + #去除外层边框
  theme(axis.line = element_blank(),axis.ticks = element_blank(),axis.text = element_blank()) + #去掉坐标轴
  ggtitle("")+
  guides(fill = FALSE) 

ggsave("sankey_stratum_3.pdf")
```

可以只选其中一部分列来画，此处只画第一列和第三列

```{r,fig.width=6,fig.height=3}
UCB_lodes <- to_lodes_form(df[,c(1,3)],
                           key = "Gene",
                           axes = 1:2,
                           id = "Cohort")
dim(UCB_lodes)

ggplot(UCB_lodes,
       aes(x = Gene, stratum = stratum, alluvium = Cohort,
           fill = stratum, label = stratum)) +
  scale_x_discrete(expand = c(0, 0)) + 
  
  #用aes.flow参数控制线从哪边来，颜色就跟哪边一致。
  #默认是forward，此处用backward。
  geom_flow(width = 1/8,aes.flow = "backward") +
  
  coord_flip() + #旋转90度
  geom_stratum(alpha = .9,width = 1/10) +
  geom_text(stat = "stratum", size = 3,color="black") +

  #如果分组少，可以用scale_fill_brewer。修改type和palette两个参数选择配色方案，更多配色方案参考下图，分别对应type参数的“Seq”、“qual”、“Div”
  #scale_fill_brewer(type = "Div", palette = "BrBG") +
  
  #如果分组太多，就要用前面自己写的配色方案
  scale_fill_manual(values = mycol) +

  xlab("") + ylab("") +
  theme_bw() + 
  theme(panel.grid =element_blank()) + 
  theme(panel.border = element_blank()) + 
  theme(axis.line.x = element_blank(),axis.ticks = element_blank(),axis.text.x = element_blank()) + #显示分组名字
  ggtitle("") +
  guides(fill = FALSE) 

ggsave("sankey_stratum_2.pdf")
```

## 后面多层继承第一层的关系（作者：大鱼海棠）

用到参数：stat = "alluvium"，即传说中的“冲击图”

此时，只有连线有颜色，每层特征列就无法填充颜色了。

```{r,fig.width=6,fig.height=5}
subdf <- df

# 计算频率
subdf <- subdf %>% 
  group_by(gene, mutation, subtype) %>% #如果有更多列，就在括号里继续添加列名
  tally(name = "Freq") %>% 
  as.data.frame()
head(subdf)

ggplot(as.data.frame(subdf),
       aes(y = Freq,
           axis1 = gene, 
           axis2 = mutation, 
           axis3 = subtype)) + #这里画三列，如果有更多列，就继续添加，例如axis4 = 列名
  scale_fill_manual(values = mycol) + 
  ggalluvial::geom_flow(stat = "alluvium",width = 1/8,aes(fill = gene)) +
  geom_stratum(width = 1/8, reverse = T) +
  geom_text(stat = "stratum", size = 3, aes(label = after_stat(stratum)),
            reverse = T) +
  scale_x_continuous(breaks = 1:3, labels = c("gene", "mutation", "subtype")) +
  
  theme(legend.position = "bottom", #底部画图例
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(size = 12, face = "bold", color = "black")) +
  
  xlab("") + ylab("") +
  theme_bw() + #去除背景色
  theme(panel.grid =element_blank()) + #去除网格线
  theme(panel.border = element_blank()) + #去除外层边框
  theme(axis.line = element_blank(),axis.ticks = element_blank(), #不画xy轴
        axis.text.y = element_blank()) + # 只保留x轴label
  ggtitle("")
ggsave("sankey_alluvium.pdf")
```

# Sessioninfo

```{r}
sessionInfo()
```
