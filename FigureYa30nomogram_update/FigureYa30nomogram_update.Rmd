---
title: "FigureYa30nomogram_update"
author: "小丫画图出品"
date: "2020-9-24"
output: html_document
---
微信ID: epigenomics  E-mail: figureya@126.com

作者：齐德龙，邮箱：708902023@qq.com

小丫编辑校验

更新：小丫

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

画出新型nomogram图（d）和对比曲线（f、g）

![](example.png)

出自<https://linkinghub.elsevier.com/retrieve/pii/S2352396419301884>

Fig. 3. (d–e) Nomograms for predicting the probability of patient mortality based on TMRS-RFS (d), TMRS-OS (e) and clinical variables; (f–g) Plots depict the calibration of nomograms based on TMRS-RFS (f) and TMRS-OS (g) in terms of agreement between predicted and observed 2-year, 3-year, and 5-year outcomes. Nomogram performance is shown by the plot, relative to the 45-degree line, which represents the ideal prediction; (h–i) Decision curve analyses of the nomograms based on TMRS-RFS (h) and TMRS-OS (i) for 2-year, 3-year, and 5-year risk. ADJC, adjuvant chemotherapy; TMRS, tumour microenvironment risk score; RFS, relapse-free survival; OS, overall survival; Pr, probability; Nomo, nomogram.

c森林图的画法可参考`FigureYa90subgroup`来画，h和i图可参考`FigureYa33DCA_update`。

# 应用场景

列线图（nomogram，诺莫图）是在平面直角坐标系中用一簇互不相交的线段表示多个独立变量之间函数关系的图。

将Logistic回归或Cox回归的结果进行可视化呈现，给出其发病风险或比例风险。

关注“小丫画图”微信公众号，回复“30”查看这两个图在更多文章中的应用。

# 环境设置

使用国内镜像安装包

```{r eval=FALSE}
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.tuna.tsinghua.edu.cn/bioconductor/")
install.packages("rms","nomogramEx","regplot","vioplot","sm","beanplot")
```

加载包

```{r}
library(survival)
library(regplot)
library(rms)
library(nomogramEx)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

# 输入文件

至少要有临床信息`easy_input.csv`，还可以把`FigureYa31lasso`输出的`lasso_output.txt`作为一列添加进来。

```{r}
pbc <- read.table("easy_input.txt")

pbc$catbili <- cut(pbc$bili, breaks = c(-Inf, 2, 4, Inf),
                   labels=c("low", "medium", "high"))
pbc$died <- pbc$status == 2

head(pbc)
```

# 画nomogram

这里提供两种风格的nomogram画法，用到不同的包

## 经典版

```{r,message=FALSE,warning=FALSE,fig.width=10,fig.height=6}
dd <- datadist(pbc)
options(datadist="dd")
options(na.action="na.delete")
summary(pbc$time)
coxpbc <- cph(formula = Surv(time,died) ~  age + catbili + sex + copper + stage + trt ,data=pbc,x=T,y=T,surv = T,na.action=na.delete)  #,time.inc =2920

print(coxpbc)
surv <- Survival(coxpbc) 
surv3 <- function(x) surv(1825,x)
surv4 <- function(x) surv(2920,x)

x <- nomogram(coxpbc,fun = list(surv3,surv4),lp=T,
            funlabel = c('5-year survival Probability','8-year survival Probability'),
            maxscale = 100,fun.at = c(0.95,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1))

pdf("nomogram_classical.pdf",width = 12,height = 10)
plot(x, lplabel="Linear Predictor",
     xfrac=.35,varname.label=TRUE, varname.label.sep="=", ia.space=.2, 
     tck=NA, tcl=-0.20, lmgp=0.3,
     points.label='Points', total.points.label='Total Points',
     total.sep.page=FALSE, 
     cap.labels=FALSE,cex.var = 1.6,cex.axis = 1.05,lwd=5,
     label.every = 1,col.grid = gray(c(0.8, 0.95)))
dev.off()
```

![](nomogram_classical.pdf)

输出公式

```{r}
#print(x)
nomogramEx(nomo=x,np=2,digit = 9)
```

# 画新型nomogram

`regplot`可以交互式调整nomogram，代码更简单，输出的图形更漂亮。

关注“小丫画图”微信公众号，回复“30”看用法小视频。

把`regplot`那段代码粘贴到Console里，回车，就会在Plots窗口出现可以交互的图。

鼠标点击Esc或按键盘上的Esc可以退出交互模式。

**怎样保存图片？**

点击Export右侧的小三角形，Save as PDF...，保存为PDF文件。

```{r}
pbccox <- coxph(formula = Surv(time,died) ~  age + catbili + sex + 
                   copper + stage + trt , data = pbc)

regplot(pbccox,
        observation=pbc[2,], #对观测2的六个指标在列线图上进行计分展示，也可以不展示
        points = TRUE, #If FALSE the regression scores of each βx contribution are shown. Otherwise contributions are represented by a 0-100 "points" scale.
        plots = c("density", #可选"no plot" "density" "boxes" "ecdf" "bars" "boxplot" "violin" "bean" "spikes"
                  "boxes"), #可选"no plot" "boxes" "bars" "spikes"
        failtime = c(1095,1825), #预测3年和5年的死亡风险，此处单位是day
        subticks = TRUE, 
        #clickable=TRUE, #可以用鼠标点击
        prfail = TRUE, #cox回归中需要TRUE
        showP = T, #是否展示统计学差异
        droplines = F,#观测2示例计分是否画线
        rank="range", #rank="range" is by the range of the βx's, and rank="sd" is by the standard deviation of the βx's. 
        interval="confidence") #展示观测的可信区间
```

展示逻辑回归，支持"lm", "glm", "coxph", "survreg" "negbin"

可参考上图调参数

```{r}
## Plot a logistic regression, showing odds scale and confidence interval
pbcglm <- glm(died ~  age + catbili + sex + copper, family = "binomial", data=pbc )

regplot(pbcglm, 
        observation=pbc[1,], 
        points = TRUE, 
        subticks = TRUE, 
        clickable=TRUE,
        odds=TRUE, 
        interval="confidence")
```

# 绘制calibration curve进行验证

采用和nomogram一样的变量进行多因素cox回归

## 5年

```{r}
f5 <- cph(formula = Surv(time,died) ~  age + catbili + sex + copper +stage + trt,data=pbc,x=T,y=T,surv = T,na.action=na.delete,time.inc = 1825) 

#参数m=50表示每组50个样本进行重复计算
cal5 <- calibrate(f5, cmethod="KM", method="boot",u=1825,m=50,B=1000) 

pdf("calibration_5y.pdf",width = 8,height = 8)
plot(cal5,
     lwd = 2,#error bar的粗细
     lty = 1,#error bar的类型，可以是0-6
     errbar.col = c("#2166AC"),#error bar的颜色
     xlim = c(0,1),ylim= c(0,1),
     xlab = "Nomogram-prediced OS (%)",ylab = "Observed OS (%)",
     cex.lab=1.2, cex.axis=1, cex.main=1.2, cex.sub=0.6) #字的大小
lines(cal5[,c('mean.predicted',"KM")], 
      type = 'b', #连线的类型，可以是"p","b","o"
      lwd = 2, #连线的粗细
      pch = 16, #点的形状，可以是0-20
      col = c("#2166AC")) #连线的颜色
mtext("")
box(lwd = 1) #边框粗细
abline(0,1,lty = 3, #对角线为虚线
       lwd = 2, #对角线的粗细
       col = c("#224444")#对角线的颜色
       ) 
dev.off()
```

![](calibration_5y.pdf)

## 8年

```{r, fig.width=8,highlight=8}
f8 <- cph(formula = Surv(time,died) ~  age + catbili + sex + copper +stage + trt,data=pbc,x=T,y=T,surv = T,na.action=na.delete,time.inc = 2920) 
cal8 <- calibrate(f8, cmethod="KM", method="boot",u=2920,m=50,B=1000)

plot(cal8,
     lwd = 2,
     lty = 1,
     errbar.col = c("#B2182B"),
     xlim = c(0,1),ylim= c(0,1),
     xlab = "Nomogram-prediced OS (%)",ylab = "Observed OS (%)",
     col = c("#B2182B"),
     cex.lab=1.2,cex.axis=1, cex.main=1.2, cex.sub=0.6)
lines(cal8[,c('mean.predicted',"KM")],
      type= 'b',
      lwd = 2,
      col = c("#B2182B"),
      pch = 16)
mtext("")
box(lwd = 1)
abline(0,1,lty= 3,
       lwd = 2,
       col =c("#224444"))
```

## 同时展示两条curve

```{r}
pdf("calibration_compare.pdf",width = 8,height = 8)
plot(cal5,lwd = 2,lty = 0,errbar.col = c("#2166AC"),
     bty = "l", #只画左边和下边框
     xlim = c(0,1),ylim= c(0,1),
     xlab = "Nomogram-prediced OS (%)",ylab = "Observed OS (%)",
     col = c("#2166AC"),
     cex.lab=1.2,cex.axis=1, cex.main=1.2, cex.sub=0.6)
lines(cal5[,c('mean.predicted',"KM")],
      type = 'b', lwd = 1, col = c("#2166AC"), pch = 16)
mtext("")

plot(cal8,lwd = 2,lty = 0,errbar.col = c("#B2182B"),
     xlim = c(0,1),ylim= c(0,1),col = c("#B2182B"),add = T)
lines(cal8[,c('mean.predicted',"KM")],
      type = 'b', lwd = 1, col = c("#B2182B"), pch = 16)

abline(0,1, lwd = 2, lty = 3, col = c("#224444"))

legend("topleft", #图例的位置
       legend = c("5-year","8-year"), #图例文字
       col =c("#2166AC","#B2182B"), #图例线的颜色，与文字对应
       lwd = 2,#图例中线的粗细
       cex = 1.2,#图例字体大小
       bty = "n")#不显示图例边框
dev.off()
```

![](calibration_compare.pdf)

```{r}
sessionInfo()
```
