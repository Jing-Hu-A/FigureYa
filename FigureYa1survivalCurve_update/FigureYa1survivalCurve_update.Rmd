---
title: "FigureYa1SurvivalCurve_update"
author: "小丫画图出品"
date: "2019-8-26"
output: html_document
---
小丫微信: epigenomics  E-mail: figureya@126.com

作者：贝塔猫

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

网上搜到过代码，但是都是用TCGA自己带的肺癌数据画的，我需要用自己的数据绘制。

两组或多组对比。

![](example.png)

## 使用场景

需要至少两列信息：结局和结局的发生时间。如果还要做组间对比就再来一列分组信息。

用于展示分类样本的生存曲线，或其他有结局和结局发生时间的数据。

更多应用和背景知识可参考“小白学统计”的生存分析系列：

- 生存分析（一）生存分析方法，你听说过几种？<https://mp.weixin.qq.com/s/pAVzfPLfGmnaxQ93IQgmjw>
- 生存分析（二）中位生存时间和中位随访时间，<https://mp.weixin.qq.com/s/I_sHAz-RP5s7z1-75nIFSg>
- 生存分析（三）log-rank检验在什么情况下失效？<https://mp.weixin.qq.com/s/XpPpOpeNcIDXbd6es5VnvA>
- 生存分析（四）我们的生命，能否如指数分布般平稳？<https://mp.weixin.qq.com/s/NsMX3U_Bcmyn7u6NFGIaBw>
- 生存分析（五）实用的（却又被忽略的）Weibull回归，<https://mp.weixin.qq.com/s/RsVaqu3p9SXNICWaxaPbeQ>
- 生存分析（六）如何判断你的生存数据能否用cox回归——等比例风险假定判断，<https://mp.weixin.qq.com/s/7lCRmezb0yw1JewHBw0ZrQ>

**该如何分组呢？**

可以通过best separation来按表达量高低分组，可参考FigureYa4bestSeparation用中位值分组或找最佳分组；或者批量为多个基因找最佳分组，可参考FigureYa35batch_bestSeparation。

或者不用表达量分组，而是用已知的亚型（聚类得到，或者金标准亚型）分组，可参考FigureYa116supervisedCluster，进一步用它的金标准亚型寻找marker，再利用监督层次聚类在验证集上识别新亚型。

## 环境设置

安装需要的包

```r
#使用国内镜像安装包
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
install.packages("survival")
install.packages("survminer")
```

加载需要用到的包

```{r}
library("survival")
library("survminer")

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

## 输入数据的预处理

如果你的数据已经整理成“easy_input_*.txt”的格式，就可以跳过这步，直接进入“两组对比”。

如果想获得TCGA的生存数据，可参考FigureYa128Prognostic。

需求方提供的输入数据生存期是Months列，样本分类和追踪情况揉在第2和3列中，1代表death，0代表alive，NA和1/0代表样本分类，因此，样本分类和追踪情况需要重新生成

```{r cars}
svData<-read.delim(file="not_easy_input.txt",header=T,as.is=T)
head(svData)

svData$Expression <- NA
svData$Expression[!is.na(svData$PD.L1.protein.high.expression)] <- "high"
svData$Expression[is.na(svData$PD.L1.protein.high.expression)] <- "low"
svData$Status <- 1+(!is.na(svData$PD.L1.protein.high.expression|svData$PD.L1.protein.low.expression))
head(svData[,c(1,4,5)])
write.table(svData[,c(1,4,5)],file="easy_input_2.txt",sep = "\t",col.names = T,row.names = F,quote = F)
```

可以看到重新生成后，svData中生存期、样本分类和追踪情况分别是Months、Expression、Status列。

多说一句，追踪信息遵循的规则是，The status indicator, normally 0=alive, 1=dead. Other choices are TRUE/FALSE (TRUE = death) or 1/2 (2=death)

再模拟一个3组的输入文件，仅用来展示三组对比的画法：

```{r}
svData$Expression[35:55] <- "med"
write.table(svData[,c(1,4,5)],file="easy_input_3.txt",sep = "\t",col.names = T,row.names = F,quote = F)
```

## 两组对比

### 输入文件

画图用的数据结构是一个包含样本分类、生存期和追踪情况的数据框。

```{r}
svData <- read.table("easy_input_2.txt", header = T, as.is = T)
head(svData)
unique(svData$Expression)

svData$Expression <- factor(svData$Expression, levels = c("high","low"))
```

### 开始画图

常见调整参数有颜色、线的类型、是否显示置信区间等

用?ggsurvplot查看更多参数设置

```{r}
# 这里用默认参数做回归
# 如果想先判断符合哪种分布再选择合适的方法回归，我们再众筹吧。
fit <- survfit(Surv(Months, Status) ~ Expression, data = svData)

#先用默认参数画，用于校对后面画的图
ggsurvplot(fit)

#不画置信区间
ggsurvplot(fit, pval = TRUE,linetype = c("solid", "dashed"), #线的类型
           palette = c("red","blue"),#线的颜色
           legend.title="",legend=c(0.7,0.9),#图例的位置
           legend.labs=c("High-expression","Low-expression"),
           conf.int = F) #不显示置信区间
ggsave(file="survivalcurve_2.pdf", width = 4, height = 4)

#画置信区间
pdf("survivalcurve_2_table.pdf", width = 6, height = 5)
ggsurvplot(fit, pval = TRUE, linetype = "solid", #都画实线
           palette = c("red","blue"),
           legend.title="",legend=c(0.7,0.9),
           legend.labs=c("High-expression","Low-expression"),
           
           # 画表格
           risk.table = TRUE,
           tables.height = 0.2,
           tables.theme = theme_cleantable(),

           conf.int = T,#显示置信区间
           conf.int.style="ribbon",#展示方式
           conf.int.alpha=0.1)#透明度
dev.off()
```

![](survivalcurve_2_table.pdf)

## 三组对比

如果有更多组要对比，就按照规律在参数里添加即可。

### 输入文件

```{r}
svData <- read.table("easy_input_3.txt", header = T, as.is = T)
head(svData)
unique(svData$Expression)

svData$Expression <- factor(svData$Expression, levels = c("high","med","low"))
```

### 开始画图

pvalue的计算方法可修改，可通过?surv_pvalue查看可选的method

```{r}
fit <- survfit(Surv(Months, Status) ~ Expression, data = svData)

#先用默认参数画，用于校对后面画的图
ggsurvplot(fit)

#不画置信区间
ggsurvplot(fit, pval = TRUE,linetype = c("solid", "solid", "solid"), #线的类型
           palette = c("red","navy","darkgreen"),#线的颜色
           legend.title="",legend=c(0.7,0.9), #图例的位置
           legend.labs=c("High-expression", "med-expression", "low-expression"),
           conf.int = F) #不显示置信区间
ggsave(file="survivalcurve_3.pdf", width = 4, height = 4)

#画置信区间
pdf("survivalcurve_3_table.pdf", width = 7, height = 6)
ggsurvplot(fit, pval = TRUE, linetype = "solid", #都画成实线
           palette = c("red","navy","darkgreen"),
           legend.title="",legend=c(0.8,0.9),
           legend.labs=c("High-expression","med-expression", "low-expression"),
           
           # 画表格
           risk.table = TRUE,
           tables.height = 0.3,
           tables.theme = theme_cleantable(),

           conf.int = T,#显示置信区间
           conf.int.style="ribbon",#展示方式
           conf.int.alpha=0.1)#透明度
dev.off()
```

![](survivalcurve_3_table.pdf)

输出的pdf文件是矢量图，可以在Illustrator等软件里进行字体、字号等编辑操作

```{r}
sessionInfo()
```