---
title: "FigureYa22 FPKM2TPM"
author: "小丫画图出品"
date: "2018-7-22"
output: html_document
---
微信ID: epigenomics  E-mail: figureya@126.com

作者：小丫

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

把RNA-seq的FPKM转换成TPM。

## 应用场景

RNA-seq基因表达量是FPKM，想转变成TPM。不仅限于TCGA数据。

FPKM跟TPM的计算都考虑了基因长度，因此相对于read count转TPM来说，从FPKM转TPM最方便快捷。

如果你需要从read count转TPM，请购买FigureYa23count2TPM；从read count转FPKM，请购买FigureYa34count2FPKM。

## 下载TCGA RNA-seq的FPKM数据 

此处以TCGA的数据为例。

如果你自己的RNA-seq数据已经保存成`easy_input.txt`的格式，就跳过这步，直接进入“输入数据”

```{r,message=FALSE,warning=FALSE}
#source("https://bioconductor.org/biocLite.R")
#biocLite("TCGAbiolinks")
library(TCGAbiolinks)
expquery <- GDCquery(project = "TCGA-LIHC", 
                data.category = "Transcriptome Profiling",
                data.type = "Gene Expression Quantification",
                workflow.type = "HTSeq - FPKM" 
                )
GDCdownload(expquery)
expquery2 <- GDCprepare(expquery)
expMatrix <- TCGAanalyze_Preprocessing(expquery2)

#运行下面这行，会把FPKM保存到文件里，用来做其他的分析。
#write.table(expMatrix, "easy_input.txt", sep="\t", quote=F, row.names=T)
#此处为了发邮件方便，只保存前4个sample
write.table(expMatrix[,1:4], "easy_input.txt", sep="\t", quote=F, row.names=T)
```

## 输入数据

第一列是基因ID，第一行是sample ID。

一个单元格内是一个基因在一个sample中的read count。

```{r}
expMatrix<-read.table("easy_input.txt",header = T,row.names = 1)
#查看前三个基因的FPKM值
expMatrix[1:3,]
```

## FPKM转TPM

rsem作者Bo Li的文字描述：
<https://groups.google.com/forum/#!topic/rsem-users/uajT7gnTj-0>

`It is very easy to convert FPKM/RPKMs to TPMs. You first normalize your FPKMs from all genes so that their sum is equal to 1. Then you product 1e6 to each normalized value and you will obtain TPMs. `

先写个函数，来源 ：<https://haroldpimentel.wordpress.com/2014/05/08/what-the-fpkm-a-review-rna-seq-expression-units/>

```{r}
fpkmToTpm <- function(fpkm)
{
    exp(log(fpkm) - log(sum(fpkm)) + log(1e6))
}
```

计算TPM值，保存到tpms里
```{r}
tpms <- apply(expMatrix,2,fpkmToTpm)

#查看前三个基因的TPM值
tpms[1:3,]

#检查一下，是不是每列的总和都是1
colSums(tpms)

#把TPM值保存到文件
write.table(tpms,"TCGA_FPKM2TPM.genes.txt",quote = F)
```

```{r}
sessionInfo()
```