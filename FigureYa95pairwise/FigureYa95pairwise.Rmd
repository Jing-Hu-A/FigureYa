---
title: "FigureYa95pairwise"
author: "小丫画图出品"
date: "2019-5-20"
output: html_document
---
欢迎关注“小丫画图”公众号，同名知识星球等你加入

小丫微信: epigenomics  E-mail: figureya@126.com

作者：大鱼海棠

单位：Research Center of Biostatistics and Computational Pharmacy, China Pharmaceutical University

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

用TCGA的表达谱和体细胞突变作为输入，把体细胞突变MAF文件转为二元突变矩阵，用表达谱计算免疫细胞浸润得分；计算样本相似性并绘制相关性散点图。

（实质：对距离矩阵或相似性矩阵作相关性分析）

![](example.png)

出自<https://www.nature.com/articles/s41586-019-1032-7>

## 应用场景

多维度相关性研究，例如：推断体细胞突变和免疫浸润在影响肿瘤异质性上的相关程度。

## 环境设置

使用国内镜像安装包

```r
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("GSVA")
install.packages("ClassDiscovery")
```

加载包

```{r}
library(GSVA)
library(ClassDiscovery) #用于外部聚类
library(vegan) #用于二元变量的距离计算

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

## 输入数据预处理

需要三种文件：

- easy_input_expr1.csv，easy_input_expr2.csv，TCGA的表达数据。数据下载可参考“小丫画图”微店“TCGA”分类中以前的代码，例如FigureYa34count2FPKMv2。
- easy_input_maf1.txt，easy_input_maf2.txt，TCGA的突变数据。数据下载可参考“小丫画图”微店“TCGA”分类中以前的代码，例如FigureYa18oncoplot。
- immunitygene.csv，免疫细胞marker基因，这里用GSVA。还可以用MCPcounter，可参考FigureYa56immune_inflitration，或FigureYa71ssGSEA。

```{r}
tcga_expr_luad <- read.csv("easy_input_expr1.csv", check.names = F, row.names = 1)
tcga_expr_luad[1:3,1:3]

tcga_expr_lusc <- read.csv("easy_input_expr2.csv", check.names = F, row.names = 1)
tcga_expr_lusc[1:3,1:3]

tcga_maf_luad <- read.delim("easy_input_maf1.txt",sep = "\t",row.names = NULL,check.names = F,stringsAsFactors = F,header = T)
tcga_maf_luad[1:2,]
tcga_maf_lusc <- read.delim("easy_input_maf2.txt",sep = "\t",row.names = NULL,check.names = F,stringsAsFactors = F,header = T)

immune.signature <- read.csv("immunitygene.csv",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
head(immune.signature)
```

### 将详细突变的MAF文件转化为二元突变矩阵

先自定义个函数

```{r}
# 将MAF文件转换为二元突变矩阵
maf2binary <- function(maf = NULL, rmType = NULL, selSam = NULL) {
  if(!is.null(selSam)) {
    tmp <- as.data.frame(maf[which(maf$Tumor_Sample_Barcode %in% selSam),c("Variant_Classification","Tumor_Sample_Barcode","Hugo_Symbol")])
  } else {
    tmp <- as.data.frame(maf[,c("Variant_Classification","Tumor_Sample_Barcode","Hugo_Symbol")])
  }
  
  mut.binary <- matrix(0,nrow = length(unique(tmp$Hugo_Symbol)),ncol = length(unique(tmp$Tumor_Sample_Barcode)),dimnames = list(c(unique(tmp$Hugo_Symbol)),unique(tmp$Tumor_Sample_Barcode)))
  
  # 这里我只想到了循环，喜欢提高运算速度的朋友可以改进。
  for (i in colnames(mut.binary)) {
    tmp1 <- tmp[which(tmp$Tumor_Sample_Barcode == i),]
    
    if(!is.null(rmType)) {
      if(is.element(rmType,tmp$Variant_Classification)) { #确保有这个突变，否则下面负索引会出错
        tmp1 <- tmp1[-which(tmp1$Variant_Classification %in% rmType),] #移除不想要的突变类型
      }
    }
    
    for (j in tmp1$Hugo_Symbol)
      mut.binary[j,i] <- 1
  }
  mut.binary <- as.data.frame(mut.binary); rownames(mut.binary) <- toupper(rownames(mut.binary))
  return(mut.binary)
}
```

用上面的函数，将详细突变的MAF文件转化为二元突变矩阵（移除沉默突变）

```{r}
tcga_mut_luad <- maf2binary(maf=tcga_maf_luad,rmType = "Silent") 
tcga_mut_lusc <- maf2binary(maf=tcga_maf_lusc,rmType = "Silent") 

#保存到文件
write.table(tcga_mut_luad,"easy_input_mut1.txt",sep = "\t",row.names = T,col.names = NA,quote = F)
write.table(tcga_mut_lusc,"easy_input_mut2.txt",sep = "\t",row.names = T,col.names = NA,quote = F)

### 提出超过5%的突变 ###
index_luad <- which(rowSums(tcga_mut_luad)/ncol(tcga_mut_luad) > 0.05)
index_lusc <- which(rowSums(tcga_mut_lusc)/ncol(tcga_mut_lusc) > 0.05)
```

### 计算免疫浸润

```{r}
cell.type <- unique(immune.signature$CellType)
immune.sig <- list()
for (i in cell.type) {
  immune.sig[[i]] <- toupper(immune.signature[which(immune.signature$CellType == i),"Symbol"])
}

tcga_gsva_luad <- as.data.frame(gsva(as.matrix(tcga_expr_luad), immune.sig, method = "ssgsea"))
tcga_gsva_lusc <- as.data.frame(gsva(as.matrix(tcga_expr_lusc), immune.sig, method = "ssgsea"))
```

## 样本聚类提取距离

```{r}
# 确保样本顺序一致
sam_luad <- intersect(colnames(tcga_expr_luad),colnames(tcga_mut_luad))
sam_lusc <- intersect(colnames(tcga_expr_lusc),colnames(tcga_mut_lusc))

dist.gsva.luad <- as.matrix(distanceMatrix(as.matrix(tcga_gsva_luad[,sam_luad]), "euclidean"))
dist.gsva.luad[1:3,1:3]
dist.gsva.lusc <- as.matrix(distanceMatrix(as.matrix(tcga_gsva_lusc[,sam_lusc]), "euclidean"))
dist.gsva.lusc[1:3,1:3]

# 个人认为由于突变是二元变量，使用jaccard index比欧氏距离更好。
dist.mut.luad <- as.matrix(vegdist(t(as.matrix(tcga_mut_luad[index_luad,sam_luad])), method = "jaccard")) 
dist.mut.luad[1:3,1:3]
dist.mut.lusc <- as.matrix(vegdist(t(as.matrix(tcga_mut_lusc[index_lusc,sam_lusc])), method = "jaccard"))
dist.mut.lusc[1:3,1:3]


### 构建散点图的横轴纵轴（看需求描述）
# 先自定义一个函数，将配对距离转化为点的位置--x轴y轴
dist2xy <- function(dist1=NULL,dist2=NULL,sam=NULL) {
  # 这里我只想到了循环，喜欢提高运算速度的朋友可以改进。
  scat.mat <- NULL
  for (i in 1:(length(sam) - 1)) {
    cat("Index: ",i,"\n")
    for (j in (i + 1):length(sam)) {
      tmp <- data.frame(x=dist1[i,j],y=dist2[i,j],stringsAsFactors = F)
      scat.mat <- rbind.data.frame(scat.mat,tmp)
    }
  }
  if(!dim(scat.mat)[1] == length(sam)*(length(sam)-1)/2) {
    stop("Error!\n") #确保组合数正确
  } else {
    return(scat.mat)
  }
}

#计算距离
scat.luad <- dist2xy(dist1 = dist.gsva.luad, dist2 = dist.mut.luad,sam = sam_luad)
scat.luad[1:3,1:2]

scat.lusc <- dist2xy(dist1 = dist.gsva.lusc, dist2 = dist.mut.lusc,sam = sam_lusc)
scat.lusc[1:3,1:2]
```

## 开始画图

画相关性散点图，这里只简单使用baseplot画scatter plot，可换用ggplot、ggpubr。

多组情况也可参考FigureYa62twoAxis，把突变和免疫浸润分别画在左右两个y轴上

如果嫌点太多，可以通过取bin来缩减点的数量。

```{r}
violet <- "#89439B"
pink  <- "#f2d7ee"

#可换用其他相关性方法比如例图中的spearman
r.luad <- cor.test(scat.luad$x,scat.luad$y,method = "pearson",conf.level = .95) 
r.lusc <- cor.test(scat.lusc$x,scat.lusc$y,method = "pearson",conf.level = .95)

pdf("correlation plot between two distance factors.pdf", width = 5, height = 4.5)
par(xpd=NA, bty="l", mgp = c(2.3,.4,0), #坐标轴标签和title的位置
    las=1, tcl=-.25, font.main=3, 
    mar = par()$mar + c(3,0,0,3)) #在底部留出图例的地方

plot(scat.luad$x, scat.luad$y, 
     main = "", xlab = "Pairwise immunologic distance", ylab = "Pairwise genomic distanse",
     pch = 19, 
     # 由于原文提到的是region，我这里用的是样本，所以排列组合数会很多，scatter plot中的点也会很密集，所以用alpha来弱化。
     col=ggplot2::alpha(violet,0.5)) 

points(scat.lusc$x, scat.lusc$y, 
       pch = 19, 
       col=ggplot2::alpha(pink,0.5))

# 添加额外信息，具体位置要视情况自己调整一下
text(max(scat.luad$x,scat.lusc$x), max(scat.luad$y,scat.lusc$y) - 0.02, 
     paste("Lung adenocarcinoma\nP ",
     ifelse(r.luad$p.value < 0.001,"< 0.001",paste0("= ",round(r.luad$p.value,3))), 
     "\nPearson's rho = ", round(r.luad$estimate,3), sep = ''), pos = 2, cex = .8) #若换用其他相关性方法请注意修改标签

text(max(scat.luad$x,scat.lusc$x), min(scat.luad$y,scat.lusc$y) + 0.02, 
     paste("Lung squamous cell carcinoma\nP ",
     ifelse(r.lusc$p.value < 0.001,"< 0.001",paste0("= ",round(r.lusc$p.value,3))), 
     "\nPearson's rho = ", round(r.lusc$estimate,3), sep = ''), pos = 2, cex = .8) 

#添加图例
legend("bottom", 
       inset=c(0, -0.6), #把图例画到图外
       pch=19, cex = .8,
       col=c(violet, pink), 
       legend=c("Lung adenocarcinoma", "Lung squamous cell carcinoma"), 
       bty="n")

invisible(dev.off())
```

![](correlation plot between two distance factors.pdf)

```{r}
sessionInfo()
```