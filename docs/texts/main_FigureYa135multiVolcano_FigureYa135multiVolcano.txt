FigureYa135multiVolcano
FigureYa135multiVolcano
小丫画图出品
2019-9-29
欢迎关注“小丫画图”公众号，同名知识星球等你加入
小丫微信: epigenomics E-mail:
figureya@126.com
作者：qliu
小丫编辑校验
需求描述
从形式上复现文章里的这个复杂火山图。
出自
https://onlinelibrary.wiley.com/doi/abs/10.1002/ijc.31765
Figure 1. DMPs analysis in LSTs cases and controls. (b) Volcano plot of top DMPs and position of methylation probes in relation to the gene (IGR, intergenic region; TSS, transcription start site; UTR, untranslated region). The percentages of hypermethylated and hypomethylated DMPs are displayed on top. The proportions of different genomic features are shown on the right.
图的解析：
中央散点图横坐标是甲基化差异（foldchange），纵坐标是P value；
右侧是位于各特征区域内的位点所在百分比，根据feature计算而来
顶部是对位点的另一层分类信息hypo、hyper所在的百分比，根据散点图横坐标beta-value计算而来。
应用场景
同时展示多层信息，不仅限于例文中的甲基化位点。
还可以换成差异表达基因，把横坐标deltabeta换成foldchange，feature换成基因分类即可。
环境设置
使用国内镜像安装包
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
# BiocManager::install("janitor")
加载包
library(magrittr)
library(ggplot2)
library(ggrepel)
library(janitor)
library(cowplot)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
输入文件
easy_input.csv，包含四列：
第一列ID，用于在图中标出P value低的位点ID。
第二列p value，用于画散点图。
第三列deltaBeta（foldchange），用于画散点图。另外，这里会用这列计算hypo和hypermethylated的百分比，用来画顶端百分比图。如果你不想用deltaBeta列来计算百分比，可以直接给出百分比，详见文档中“顶部百分比图
p3
的绘制”部分。
第四列feature，用于画右侧柱状图。这里是位点所在的基因组位置特征，也可以换做其他特征，例如差异表达基因所在的通路、编码/非编码、原癌/抑癌等。
data <- read.csv("easy_input.csv", check.names=FALSE)
row.names(data) <- data[, 1]
colnames(data)[1] <- "Geneid"
head(data)
下面分别绘制散点图、顶部比例和右侧bar plot，最后组图。
散点图
p1
的绘制
p1 <- ggplot(data, aes(deltaBeta, -log10(data$P.Value))) +
  # 只给-log10(data$P.Value) > 60 的点写文字标签
  geom_text_repel(aes(deltaBeta, -log10(data$P.Value),
                      label = ifelse(-log10(data$P.Value) > 60, rownames(data), ""))) + 
  geom_point(aes(color = feature)) +
  guides(colour = guide_legend(override.aes = list(size=5))) + # 修改 legeng size 大小
  theme(legend.position = "none") + # 去掉图例
  labs(x = "Methylation difference (beta-value)",
       y = bquote(~-log[10]~(italic("P-value")))) + #参考了FigureYa59Volcano
  theme(axis.title.x = element_text(color="black", size = 14, face = "bold"),
        axis.title.y = element_text(color="black", size = 14, face = "bold"))

p1
# 原图带灰色背景和网格线

# 如果想去除背景和网格线，就运行下面这段
p1 <- p1 + theme_classic() +
  theme(#panel.background = element_rect(fill = NA),
        panel.border = element_rect(color = NA, fill = NA, size = 2),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = c(0, 25, 50, 75, 100),
                     labels = c(0, 25, 50, 75, ""),
                     limits = c(0, 100))
p1
散点图右侧面的柱子图
p2
的绘制
# 获得 Percent 中计数列的 n 的最大值
n_max = max(Percent$n)
n_max
顶部百分比图
p3
的绘制
首先计算
Hyper
和
Hypo
各占的比例，看图两者加起来是百分之一百，这里没有 0 ，就不考虑 0 了。
因此定义
> 0
就为
Hyper
,
< 0
就为
Hypo
。得到
Hyper
所占百分比为 68.44 %, 得到
Hypo
所占百分比为 31.56 %
percent_Hyper <- sum(data$deltaBeta < 0) / nrow(data)
paste("Hyper was", round(percent_Hyper * 100, 2), "%" )
# 如果你不想用deltaBeta列来计算百分比，可以用以下两行直接给出百分比：
#percent_Hypo <- "0.8"
#percent_Hyper <- "0.2"

### 手动给两个百分比的文字标签写个位置
# 实际使用当中要根据自己的数据调整xmin和xmax
df1 <- data.frame(xmin = c(-350, 500, 1928, 4591),
                  xmax = c(500, 1928, 4591, 6500),
                  ymin = 00,
                  ymax = 100,
                  class  = c("A","B","C","A"),
                  text = c(paste(round(percent_Hyper * 100, 2), "%" ),  "", "", paste(round(percent_Hypo * 100, 2), "%" )))
df1
组图
combined_plot <- insert_xaxis_grob(p1, p3, 
                                   position = "top",
                                   height = grid::unit(0.4, "in") # 调节高度比
) 

combined_plot <- insert_yaxis_grob(combined_plot, p2, 
                                   position = "right",
                                   width = grid::unit(2.5, "in")
)
# ggdraw(combined_plot) 

subtitle_theme_1 <- ggdraw() +
  draw_label("Hyermethylated DMPs          Hypomethylated DMPs",
             x = 0.1, y = 0.25,
             hjust = 0, vjust = 1.01, size = 10,  fontface = "bold")

p <- plot_grid(subtitle_theme_1, combined_plot, ncol = 1, 
               rel_heights = c(0.1, 1)) #顶部百分比图和散点图的比例
p
# 保存到文件
ggsave("multiVolcano.pdf")
sessionInfo()