---
title: "FigureYa129TCGAbox"
author: "小丫画图出品"
date: "2019-8-18"
output: html_document
---
欢迎关注“小丫画图”公众号，同名知识星球等你加入

小丫微信: epigenomics  E-mail: figureya@126.com

作者：LiYin

小丫编辑校验

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述

用TCGA数据画这种图，在不同分期对比不同分型里某个基因的表达量。从数据下载到出图。

![](example.png)

出自<https://www.tandfonline.com/doi/full/10.1080/2162402X.2016.1196310>

Figure 2. PD-L1 expression in molecular subtypes (A, B)

To investigate the molecular relevance between PD-L1 and glioma, we asked the distribution of PD-L1 expression in different molecular subtypes defined by TCGA network. As shown in Figs. 2A and B PD-L1 was significantly upregulated in mesenchymal subtype than other subtypes in both CGGA and TCGA dataset, except for classical subtype in CGGA data set, which also showed apparent trend although not significant. This result enlightened us that PD-L1 may serve as a biomarker for mesenchymal subtype.

## 应用场景

基因在哪个分期能区分不同亚型？画这个图一目了然。

然后还可以像例文那样接着画ROC曲线，画法可参考FigureYa24ROC。

甚至你可以写成循环，批量画出多个基因，看看哪几个基因的分型效果更好。

## 环境设置

使用国内镜像安装包

```{r}
options("repos"= c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror="http://mirrors.ustc.edu.cn/bioc/")
```

加载包

```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(data.table)
library(gtools)
library(ggsignif)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

## 输入文件的下载：

下面4个文件我上传到微云上了，下载地址：<https://share.weiyun.com/5F4J859>，你可以选择从微云下载，或者用下面的下载地址分别下载，一样的。

从xena<https://xenabrowser.net/datapages/>下载感兴趣的癌症的表达数据和临床信息。此处以例文数据为例：

先进入LGG + GBM的基因表达和临床资料所在页面，TCGA lower grade glioma and glioblastoma (GBMLGG) (14 datasets)：<https://xenabrowser.net/datapages/?cohort=TCGA%20lower%20grade%20glioma%20and%20glioblastoma%20(GBMLGG)&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>：

- gene expression RNAseq，IlluminaHiSeq (n=702) TCGA hub，下载地址：<https://tcga.xenahubs.net/download/TCGA.GBMLGG.sampleMap/HiSeqV2.gz>

- somatic non-silent mutation (gene-level)，PANCAN AWG (n=461) TCGA hub，下载地址：<https://tcga.xenahubs.net/download/TCGA.GBMLGG.sampleMap/mutation.gz>

- phenotype，Phenotypes (n=1,148) TCGA hub，下载地址：<https://tcga.xenahubs.net/download/TCGA.GBMLGG.sampleMap/GBMLGG_clinicalMatrix.gz>

再进入LGG的WHO grade资料所在页面，TCGA Lower Grade Glioma (LGG) (27 datasets)：<https://xenabrowser.net/datapages/?dataset=TCGA.LGG.sampleMap%2FLGG_clinicalMatrix&host=https%3A%2F%2Ftcga.xenahubs.net&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>：

- phenotype，Phenotypes (n=530) TCGA hub，下载地址：<https://tcga.xenahubs.net/download/TCGA.LGG.sampleMap/LGG_clinicalMatrix.gz>

## 输入文件预处理

```{r}
### 读入表达矩阵
expr <- fread("HiSeqV2")
#提取PD-L1（也就是CD274）的表达值
pdl1 <- filter(expr, sample == 'CD274') #或换成其他基因
pdl1 <- as.data.frame(t(pdl1))
colnames(pdl1) <- 'CD274' #基因名作为列名
pdl1$sample <- row.names(pdl1)
pdl1 <- pdl1[-1,]

### 读入突变数据
mut <- fread('mutation')
#提取IDH1突变
mut_IDH1 <- filter(mut ,sample=='IDH1') #或换成其他突变基因
mut_IDH1 <- as.data.frame(t(mut_IDH1))
colnames(mut_IDH1) <- 'IDH1' #基因名作为列名
mut_IDH1$sample <- row.names(mut_IDH1)
mut_IDH1<-mut_IDH1[-1,]

# merge pdl1表达和IDH1突变数据
exp_mut <- left_join(mut_IDH1, pdl1)


### 读入临床数据
# 读入并提取WHO grade
clinica <- fread('GBMLGG_clinicalMatrix')
clinica <- clinica[,c(1,20)]
# 读入LGG的临床信息
lgg <- fread('LGG_clinicalMatrix')
lgg <- lgg[,c(1,75)]
# 合并
clniical_all <- right_join(lgg,clinica)

# glioblastoma直接列为Grade IV
clniical_all$grade <- na.replace(clniical_all$neoplasm_histologic_grade,'G4')
clniical_all$sample <- clniical_all$sampleID
clniical_all <- clniical_all[,c(5,4)]


### 合并所有数据（表达、突变、临床）
alldata <- left_join(clniical_all,exp_mut)

#删掉缺少值
alldata <- na.omit(alldata)
alldata <- filter(alldata,alldata$grade!='[Discrepancy]')

#把g替换为grade
alldata$grade <- str_replace_all(alldata$grade,'G','Grade ')
alldata$grade <- str_replace_all(alldata$grade,'4','IV')
alldata$grade <- str_replace_all(alldata$grade,'3','III')
alldata$grade <- str_replace_all(alldata$grade,'2','II')

# 突变也改一下
alldata$mut <- ifelse(alldata$IDH1=='0','WT','Mut')
alldata$CD274 <- as.numeric(alldata$CD274)
```

## 开始画图

```{r}
ggplot(alldata,aes(x=mut, y=CD274)) + 
  geom_boxplot(aes(color=mut),alpha=0,width=0.6)+
  facet_grid(.~grade)+ #按grade分面
  geom_jitter(aes(color=mut),width = 0.2)+
  theme_bw()+
  geom_signif(comparisons = list(c('Mut','WT')),map_signif_level = T,
              test = 'wilcox.test')+ #或者换成t检验，就是t.test
  ylab('PD-L1 Expression')+
  guides(color=FALSE)+
  xlab('IDH Mutation Status')+
  labs(title = 'PD-L1 Expression in TCGA dataset')+
  theme(title = element_text(size = 20,colour = 'black'),##设置主题
        plot.title = element_text(hjust = 0.5),
        axis.text.y = element_text(size = 11,colour = 'black'),
        axis.text.x = element_text(size = 11,colour = 'black'),
        axis.title.x = element_text(size = 15,colour = 'black'),
        axis.title.y = element_text(size = 15,colour = 'black'),
        strip.text.x = element_text(size = 15,colour = 'black'))

ggsave('PD-L1.pdf')
```

第一组不显著的那个“NS”就拿AI抹去了吧～

```{r}
sessionInfo()
```